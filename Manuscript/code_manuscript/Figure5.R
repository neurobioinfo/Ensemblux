#!/usr/bin/env Rscript

#########
# NOTES #
#########
# This code was used to produce Figure 5 of the Ensemblux manuscript

########
# Main #
########
## Load libraries
packages <- c('dplyr', 'tidyr' 'pdfCluster', 'data.table','readr','lubridate', 'tidyverse', 'moments', 'mousetrap', 'usethis', 'devtools', 'desc', 'kneedle', 'ROCit', 'ggplot2', 'factoextra', 'ggpubr', 'ComplexUpset', 'Seurat', 'Matrix', 'scCustomize', 'vctrs', 'fossil', 'openxlsx', 'stringr' )
lapply(packages, library, character.only = TRUE)

output_dir= '~/ensemblux_manuscript/Figure5'

#########################################################
# Integrate, cluster, and ARI for Day 11 Seurat objects #
#########################################################
## code
    ## Load Step 4 Seurat object generated by scRNAbox
    seu_r1 <- readRDS('~/jerber_pool5/day_11/rep1/step4/objs4/pool5_day_11_rep1.rds')
    df_r1 <- data.frame(seu_r1@meta.data)
    seu_r2 <- readRDS('~/jerber_pool5/day_11/rep2/step4/objs4/pool5_day_11_rep2.rds')
    df_r2 <- data.frame(seu_r2@meta.data)
    seu_r3 <- readRDS('~/jerber_pool5/day_11/rep3/step4/objs4/pool5_day_11_rep3.rds')
    df_r3 <- data.frame(seu_r3@meta.data)

    ## Load corresponding Ensemblux output
    ensemblux_r1 <- read.delim("~/jerber_pool5/day_11/rep1/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(ensemblux_r1) <- paste0("pool5_day_11_rep1_", ensemblux_r1$barcode)
    rownames(ensemblux_r1) == rownames(df_r1)
    ensemblux_r2 <- read.delim("~/jerber_pool5/day_11/rep2/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(ensemblux_r2) <- paste0("pool5_day_11_rep2_", ensemblux_r2$barcode)
    rownames(ensemblux_r2) == rownames(df_r2)
    ensemblux_r3 <- read.delim("~/jerber_pool5/day_11/rep3/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(ensemblux_r3) <- paste0("pool5_day_11_rep3_", ensemblux_r3$barcode)
    rownames(ensemblux_r3) == rownames(df_r3)

    ## merge Seurat and Ensemblux
    seu_r1 <- AddMetaData(seu_r1, ensemblux_r1)
    seu_r2 <- AddMetaData(seu_r2, ensemblux_r2)
    seu_r3 <- AddMetaData(seu_r3, ensemblux_r3)

    ### Prepare Seurat objects for integration
    ## Rep 1
    DefaultAssay(seu_r1) <- 'RNA'
    seu_r1<- NormalizeData(seu_r1,normalization.method = "LogNormalize", scale.factor =10000) ##new code
    seu_r1<- FindVariableFeatures(seu_r1, selection.method = "vst", nfeatures = 3000)
    seu_r1<- ScaleData(seu_r1, verbose = FALSE)

    ## Rep 2
    DefaultAssay(seu_r2) <- 'RNA'
    seu_r2<- NormalizeData(seu_r2,normalization.method = "LogNormalize", scale.factor =10000) ##new code
    seu_r2<- FindVariableFeatures(seu_r2, selection.method = "vst", nfeatures = 3000)
    seu_r2<- ScaleData(seu_r2, verbose = FALSE)

    ## Rep 3
    DefaultAssay(seu_r3) <- 'RNA'
    seu_r3<- NormalizeData(seu_r3,normalization.method = "LogNormalize", scale.factor =10000) ##new code
    seu_r3<- FindVariableFeatures(seu_r3, selection.method = "vst", nfeatures = 3000)
    seu_r3<- ScaleData(seu_r3, verbose = FALSE)

    seu_list <- list(seu_r1 = seu_r1, seu_r2 = seu_r2, seu_r3 = seu_r3)
        
    ## Select inetgration features
    features <- Seurat::SelectIntegrationFeatures(object.list = seu_list, nfeatures = 3000)

    ## Find integration anchors
    seu_anchors <- Seurat::FindIntegrationAnchors(object.list = seu_list, dims = 1:50, anchor.features = features)

    ## Integrate Seurat objects
    seu_int <- Seurat::IntegrateData(anchorset = seu_anchors,dims = 1:50)

    ## Set default assay to integrated
    Seurat::DefaultAssay(seu_int) <- "integrated"

    ## Scale integrated Seurat object
    seu_int <- ScaleData(seu_int, verbose = FALSE)

    ## Save integrated Seurat object
    saveRDS(seu_int, paste(output_dir,"/pool5_integrated_seurat_none.rds", sep=""))

    ## Cluster across clustering resolution
    par_FindClusters_resolution <- c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)
    seu_int <- FindNeighbors(seu_int,  dims = 1:50, k.param = 10, prune.SNN = 1/15)
    seu_int <- Seurat::FindClusters(seu_int, resolution = par_FindClusters_resolution)
    seu_int <- RunUMAP(seu_int, dims = 1:50)

    ## Print UMAPs at different resolutions
    for (i in par_FindClusters_resolution){
        Seurat::DimPlot(seu_int, group.by = paste("integrated_snn_res.",i,sep=''))
        ggsave(paste(output_dir,"/integrated_snn_res.",i,".pdf",sep=""))
    }

    ## Compute clustering-specific ARI
    par_RI_reps <- 25

    ## set default assay
    par_whatAssay <- "integrated"
    Seurat::DefaultAssay(seu_int) <- "integrated"

    ## create output directory for ARI outputs
    OUT_DIR <- output_dir 

    ## Function to run louvain clustering multiple times and calculate ARI
    calculate_rand_index <- function(seu_object, par_FindClusters_resolution, OUT_DIR) {
        mybiglist <- list()
        means <- list()
        standard_devs <- list()
        result <- list()
        reps = par_RI_reps
        for(i in par_FindClusters_resolution) { 
            for(n in 1:reps) { 
            seu_object <- Seurat::FindClusters(seu_int, resolution = i, random.seed = n) 
            # retrieve the clustering
            column <- paste0(par_whatAssay,"_snn_res.",i)
            df <- data.frame(seu_object@meta.data)
            df1 <- df %>% select(column)
            result[[n]] <- df1[,1]
            }
            mybiglist <- list()
            for (f in 1:length(result)){
            for (j in 1:length(result)){
                if (f==j) {
                name <- paste0(f, ",", j)
                tmp <- -5  
                mybiglist[[name]] <- tmp
                mybiglist
                } else {
                name <- paste0(f, ",", j)
                tmp <- adj.rand.index(result[[f]], result[[j]])
                mybiglist[[name]] <- tmp
                mybiglist
                }
            }
            }
            mybiglist_test <-  mybiglist[mybiglist != -5]
            
            mean <- mean(unlist((mybiglist_test)))
            sd <- sd(unlist((mybiglist_test)))
            means[[paste0("mean_",i)]] <- mean                           
            standard_devs[[paste0("sd_",i)]] <- sd                            
        }
        ## standard deviation
        # plot standard deviation
        sd_df<- data.frame(standard_devs)
        sd_df<- data.frame(t(sd_df))
        sd_df$resolution <- rownames(sd_df)
        colnames(sd_df) <- c("sd", "Resolution")
        sd_df$group = "group"
        sd_plot <- ggplot(sd_df, aes(x = Resolution, y = sd, group = group)) +
            geom_line() + geom_point() + theme_bw() +
            theme(axis.text.x = element_blank(),
                axis.title.x = element_blank(),
                axis.ticks.x = element_blank()) +
                ylab("SD ARI")
        ## means
        # plot means
        sd_mean<- data.frame(means)
        sd_mean<- data.frame(t(sd_mean))
        sd_mean$resolution <- rownames(sd_mean)
        colnames(sd_mean) <- c("mean", "Resolution")
        sd_mean$group = "group"
        mean_plot <- ggplot(sd_mean, aes(x = Resolution, y = mean, group = group)) +
            geom_line() + geom_point() + theme_bw() +
            theme(axis.text.x = element_blank(),
                axis.title.x = element_blank(),
                axis.ticks.x = element_blank()) +
                ylab("Mean ARI")

        ## arrange plots
        ggarrange(mean_plot, sd_plot, ncol = 1, nrow = 2)
        # Combine standard deviation and means list
        list3 <- c(means,standard_devs)
        list3_df <- data.frame(list3)
        list3_df
        # Write excel file
        if(file.exists(paste(OUT_DIR, "/clustering_ARI.xlsx", sep=''))){
            file.remove(paste(OUT_DIR, "/clustering_ARI.xlsx", sep=''))
        }
        write.xlsx(list3_df, paste(OUT_DIR, "/clustering_ARI.xlsx", sep='')) 
        plots <- ggarrange(mean_plot, sd_plot, ncol = 1, nrow = 2, align = "hv")
        plots
    }  

    ## Compute standard deviation and mean of ARI at different clustering resolutions
    test_plot <- calculate_rand_index(seu_int,par_FindClusters_resolution, OUT_DIR ) 

    ## function to plot ARI information and cluster resolution together
    calculate_clusters<- function(seu_int, par_FindClusters_resolution, test_plot, OUT_DIR) {
        mybiglist <- list()
        for(i in par_FindClusters_resolution) { 
            column <- paste0(par_whatAssay,"_snn_res.",i)
            df <- data.frame(seu_int@meta.data)
            df1 <- df %>% select(column)
            n_levels <-length(unique(df1[,1]))
            mybiglist[[column]] <- n_levels
        }
        mybiglist
        sd_df<- data.frame(mybiglist)
        sd_df<- data.frame(t(sd_df))
        sd_df$resolution <- rownames(sd_df)
        colnames(sd_df) <- c("cluster", "Resolution")
        sd_df$group = "group"
        cluster_plot <- ggplot(sd_df, aes(x = Resolution, y = cluster, group = group)) +
            geom_line() +
            geom_point() +
            theme_bw() +
            theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
            ylab("Number of clusters")
        ggarrange(test_plot, cluster_plot, ncol = 1, nrow = 2, heights = c(1.25,1))
        ggsave(file = paste(OUT_DIR, "/ARI.pdf", sep=''))
    }  

    ## produce final plot
    calculate_clusters(seu_int, par_FindClusters_resolution, test_plot, OUT_DIR) 
##

#########################################################
# Integrate, cluster, and ARI for Day 30 Seurat objects #
#########################################################
## code
    ## Load Step Seurat object generated by scRNAbox
    seu_r1 <- readRDS('~/jerber_pool5/day_30/rep1/step4/objs4/pool5_day_30_rep1.rds')
    df_r1 <- data.frame(seu_r1@meta.data)
    seu_r2 <- readRDS('~/jerber_pool5/day_30/rep2/step4/objs4/pool5_day_30_rep2.rds')
    df_r2 <- data.frame(seu_r2@meta.data)
    seu_r3 <- readRDS('~/jerber_pool5/day_30/rep3/step4/objs4/pool5_day_30_rep3.rds')
    df_r3 <- data.frame(seu_r3@meta.data)

    ## Load corresponding Ensemblux output
    ensemblux_r1 <- read.delim("~/jerber_pool5/day_30/rep1/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(ensemblux_r1) <- paste0("pool5_day_30_rep1_", ensemblux_r1$barcode)
    rownames(ensemblux_r1) == rownames(df_r1)
    ensemblux_r2 <- read.delim("~/jerber_pool5/day_30/rep2/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(ensemblux_r2) <- paste0("pool5_day_30_rep2_", ensemblux_r2$barcode)
    rownames(ensemblux_r2) == rownames(df_r2)
    ensemblux_r3 <- read.delim("~/jerber_pool5/day_30/rep3/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(ensemblux_r3) <- paste0("pool5_day_30_rep3_", ensemblux_r3$barcode)
    rownames(ensemblux_r3) == rownames(df_r3)

    ## merge Seurat and Ensemblux
    seu_r1 <- AddMetaData(seu_r1, ensemblux_r1)
    seu_r2 <- AddMetaData(seu_r2, ensemblux_r2)
    seu_r3 <- AddMetaData(seu_r3, ensemblux_r3)

    ### Prepare Seurat objects for integration
    ## Rep 1
    DefaultAssay(seu_r1) <- 'RNA'
    seu_r1<- NormalizeData(seu_r1,normalization.method = "LogNormalize", scale.factor =10000) ##new code
    seu_r1<- FindVariableFeatures(seu_r1, selection.method = "vst", nfeatures = 3000)
    seu_r1<- ScaleData(seu_r1, verbose = FALSE)

    ## Rep 2
    DefaultAssay(seu_r2) <- 'RNA'
    seu_r2<- NormalizeData(seu_r2,normalization.method = "LogNormalize", scale.factor =10000) ##new code
    seu_r2<- FindVariableFeatures(seu_r2, selection.method = "vst", nfeatures = 3000)
    seu_r2<- ScaleData(seu_r2, verbose = FALSE)

    ## Rep 3
    DefaultAssay(seu_r3) <- 'RNA'
    seu_r3<- NormalizeData(seu_r3,normalization.method = "LogNormalize", scale.factor =10000) ##new code
    seu_r3<- FindVariableFeatures(seu_r3, selection.method = "vst", nfeatures = 3000)
    seu_r3<- ScaleData(seu_r3, verbose = FALSE)

    seu_list <- list(seu_r1 = seu_r1, seu_r2 = seu_r2, seu_r3 = seu_r3)
        
    ## Select inetgration features
    features <- Seurat::SelectIntegrationFeatures(object.list = seu_list, nfeatures = 3000)

    ## Find integration anchors
    seu_anchors <- Seurat::FindIntegrationAnchors(object.list = seu_list, dims = 1:50, anchor.features = features)

    ## Integrate Seurat objects
    seu_int <- Seurat::IntegrateData(anchorset = seu_anchors,dims = 1:50)

    ## Set default assay to integrated
    Seurat::DefaultAssay(seu_int) <- "integrated"

    ## Scale integrated Seurat object
    seu_int <- ScaleData(seu_int, verbose = FALSE)

    ## Save integrated Seurat object
    saveRDS(seu_int, paste(output_dir,"/pool5_integrated_seurat_none.rds", sep=""))

    ## Cluster across clustering resolution
    par_FindClusters_resolution <- c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)
    seu_int <- FindNeighbors(seu_int,  dims = 1:50, k.param = 10, prune.SNN = 1/15)
    seu_int <- Seurat::FindClusters(seu_int, resolution = par_FindClusters_resolution)
    seu_int <- RunUMAP(seu_int, dims = 1:50)

    ## Print UMAPs at different resolutions
    for (i in par_FindClusters_resolution){
        Seurat::DimPlot(seu_int, group.by = paste("integrated_snn_res.",i,sep=''))
        ggsave(paste(output_dir,"/integrated_snn_res.",i,".pdf",sep=""))
    }

    ## Compute clustering-specific ARI
    par_RI_reps <- 25

    ## set default assay
    par_whatAssay <- "integrated"
    Seurat::DefaultAssay(seu_int) <- "integrated"

    ## create output directory for ARI outputs
    OUT_DIR <- output_dir 

    ## Function to run louvain clustering multiple times and calculate ARI
    calculate_rand_index <- function(seu_object, par_FindClusters_resolution, OUT_DIR) {
        mybiglist <- list()
        means <- list()
        standard_devs <- list()
        result <- list()
        reps = par_RI_reps
        for(i in par_FindClusters_resolution) { 
            for(n in 1:reps) { 
            seu_object <- Seurat::FindClusters(seu_int, resolution = i, random.seed = n) 
            # retrieve the clustering
            column <- paste0(par_whatAssay,"_snn_res.",i)
            df <- data.frame(seu_object@meta.data)
            df1 <- df %>% select(column)
            result[[n]] <- df1[,1]
            }
            mybiglist <- list()
            for (f in 1:length(result)){
            for (j in 1:length(result)){
                if (f==j) {
                name <- paste0(f, ",", j)
                tmp <- -5  
                mybiglist[[name]] <- tmp
                mybiglist
                } else {
                name <- paste0(f, ",", j)
                tmp <- adj.rand.index(result[[f]], result[[j]])
                mybiglist[[name]] <- tmp
                mybiglist
                }
            }
            }
            mybiglist_test <-  mybiglist[mybiglist != -5]
            
            mean <- mean(unlist((mybiglist_test)))
            sd <- sd(unlist((mybiglist_test)))
            means[[paste0("mean_",i)]] <- mean                           
            standard_devs[[paste0("sd_",i)]] <- sd                            
        }
        ## standard deviation
        # plot standard deviation
        sd_df<- data.frame(standard_devs)
        sd_df<- data.frame(t(sd_df))
        sd_df$resolution <- rownames(sd_df)
        colnames(sd_df) <- c("sd", "Resolution")
        sd_df$group = "group"
        sd_plot <- ggplot(sd_df, aes(x = Resolution, y = sd, group = group)) +
            geom_line() + geom_point() + theme_bw() +
            theme(axis.text.x = element_blank(),
                axis.title.x = element_blank(),
                axis.ticks.x = element_blank()) +
                ylab("SD ARI")
        ## means
        # plot means
        sd_mean<- data.frame(means)
        sd_mean<- data.frame(t(sd_mean))
        sd_mean$resolution <- rownames(sd_mean)
        colnames(sd_mean) <- c("mean", "Resolution")
        sd_mean$group = "group"
        mean_plot <- ggplot(sd_mean, aes(x = Resolution, y = mean, group = group)) +
            geom_line() + geom_point() + theme_bw() +
            theme(axis.text.x = element_blank(),
                axis.title.x = element_blank(),
                axis.ticks.x = element_blank()) +
                ylab("Mean ARI")

        ## arrange plots
        ggarrange(mean_plot, sd_plot, ncol = 1, nrow = 2)
        # Combine standard deviation and means list
        list3 <- c(means,standard_devs)
        list3_df <- data.frame(list3)
        list3_df
        # Write excel file
        if(file.exists(paste(OUT_DIR, "/clustering_ARI.xlsx", sep=''))){
            file.remove(paste(OUT_DIR, "/clustering_ARI.xlsx", sep=''))
        }
        write.xlsx(list3_df, paste(OUT_DIR, "/clustering_ARI.xlsx", sep='')) 
        plots <- ggarrange(mean_plot, sd_plot, ncol = 1, nrow = 2, align = "hv")
        plots
    }  

    ## Compute standard deviation and mean of ARI at different clustering resolutions
    test_plot <- calculate_rand_index(seu_int,par_FindClusters_resolution, OUT_DIR ) 

    ## function to plot ARI information and cluster resolution together
    calculate_clusters<- function(seu_int, par_FindClusters_resolution, test_plot, OUT_DIR) {
        mybiglist <- list()
        for(i in par_FindClusters_resolution) { 
            column <- paste0(par_whatAssay,"_snn_res.",i)
            df <- data.frame(seu_int@meta.data)
            df1 <- df %>% select(column)
            n_levels <-length(unique(df1[,1]))
            mybiglist[[column]] <- n_levels
        }
        mybiglist
        sd_df<- data.frame(mybiglist)
        sd_df<- data.frame(t(sd_df))
        sd_df$resolution <- rownames(sd_df)
        colnames(sd_df) <- c("cluster", "Resolution")
        sd_df$group = "group"
        cluster_plot <- ggplot(sd_df, aes(x = Resolution, y = cluster, group = group)) +
            geom_line() +
            geom_point() +
            theme_bw() +
            theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
            ylab("Number of clusters")
        ggarrange(test_plot, cluster_plot, ncol = 1, nrow = 2, heights = c(1.25,1))
        ggsave(file = paste(OUT_DIR, "/ARI.pdf", sep=''))
    }  

    ## produce final plot
    calculate_clusters(seu_int, par_FindClusters_resolution, test_plot, OUT_DIR) 
##

#########################################################
# Integrate, cluster, and ARI for Day 30 Seurat objects #
#########################################################
## code
    ## Load Step Seurat object generated by scRNAbox
    seu_r1 <- readRDS('~/jerber_pool5/day_52ctrl/rep1/step4/objs4/pool5_day_52ctrl_rep1.rds')
    df_r1 <- data.frame(seu_r1@meta.data)
    seu_r2 <- readRDS('~/jerber_pool5/day_52ctrl/rep2/step4/objs4/pool5_day_52ctrl_rep2.rds')
    df_r2 <- data.frame(seu_r2@meta.data)
    seu_r3 <- readRDS('~/jerber_pool5/day_52ctrl/rep3/step4/objs4/pool5_day_52ctrl_rep3.rds')
    df_r3 <- data.frame(seu_r3@meta.data)

    ## Load corresponding Ensemblux output
    ensemblux_r1 <- read.delim("~/jerber_pool5/day_52ctrl/rep1/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(ensemblux_r1) <- paste0("pool5_day_52ctrl_rep1_", ensemblux_r1$barcode)
    rownames(ensemblux_r1) == rownames(df_r1)
    ensemblux_r2 <- read.delim("~/jerber_pool5/day_52ctrl/rep2/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(ensemblux_r2) <- paste0("pool5_day_52ctrl_rep2_", ensemblux_r2$barcode)
    rownames(ensemblux_r2) == rownames(df_r2)
    ensemblux_r3 <- read.delim("~/jerber_pool5/day_52ctrl/rep3/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(ensemblux_r3) <- paste0("pool5_day_52ctrl_rep3_", ensemblux_r3$barcode)
    rownames(ensemblux_r3) == rownames(df_r3)

    ## merge Seurat and Ensemblux
    seu_r1 <- AddMetaData(seu_r1, ensemblux_r1)
    seu_r2 <- AddMetaData(seu_r2, ensemblux_r2)
    seu_r3 <- AddMetaData(seu_r3, ensemblux_r3)

    ### Prepare Seurat objects for integration
    ## Rep 1
    DefaultAssay(seu_r1) <- 'RNA'
    seu_r1<- NormalizeData(seu_r1,normalization.method = "LogNormalize", scale.factor =10000) ##new code
    seu_r1<- FindVariableFeatures(seu_r1, selection.method = "vst", nfeatures = 3000)
    seu_r1<- ScaleData(seu_r1, verbose = FALSE)

    ## Rep 2
    DefaultAssay(seu_r2) <- 'RNA'
    seu_r2<- NormalizeData(seu_r2,normalization.method = "LogNormalize", scale.factor =10000) ##new code
    seu_r2<- FindVariableFeatures(seu_r2, selection.method = "vst", nfeatures = 3000)
    seu_r2<- ScaleData(seu_r2, verbose = FALSE)

    ## Rep 3
    DefaultAssay(seu_r3) <- 'RNA'
    seu_r3<- NormalizeData(seu_r3,normalization.method = "LogNormalize", scale.factor =10000) ##new code
    seu_r3<- FindVariableFeatures(seu_r3, selection.method = "vst", nfeatures = 3000)
    seu_r3<- ScaleData(seu_r3, verbose = FALSE)

    seu_list <- list(seu_r1 = seu_r1, seu_r2 = seu_r2, seu_r3 = seu_r3)
        
    ## Select inetgration features
    features <- Seurat::SelectIntegrationFeatures(object.list = seu_list, nfeatures = 3000)

    ## Find integration anchors
    seu_anchors <- Seurat::FindIntegrationAnchors(object.list = seu_list, dims = 1:50, anchor.features = features)

    ## Integrate Seurat objects
    seu_int <- Seurat::IntegrateData(anchorset = seu_anchors,dims = 1:50)

    ## Set default assay to integrated
    Seurat::DefaultAssay(seu_int) <- "integrated"

    ## Scale integrated Seurat object
    seu_int <- ScaleData(seu_int, verbose = FALSE)

    ## Save integrated Seurat object
    saveRDS(seu_int, paste(output_dir,"/pool5_integrated_seurat_none.rds", sep=""))

    ## Cluster across clustering resolution
    par_FindClusters_resolution <- c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)
    seu_int <- FindNeighbors(seu_int,  dims = 1:50, k.param = 10, prune.SNN = 1/15)
    seu_int <- Seurat::FindClusters(seu_int, resolution = par_FindClusters_resolution)
    seu_int <- RunUMAP(seu_int, dims = 1:50)

    ## Print UMAPs at different resolutions
    for (i in par_FindClusters_resolution){
        Seurat::DimPlot(seu_int, group.by = paste("integrated_snn_res.",i,sep=''))
        ggsave(paste(output_dir,"/integrated_snn_res.",i,".pdf",sep=""))
    }

    ## Compute clustering-specific ARI
    par_RI_reps <- 25

    ## set default assay
    par_whatAssay <- "integrated"
    Seurat::DefaultAssay(seu_int) <- "integrated"

    ## create output directory for ARI outputs
    OUT_DIR <- output_dir 

    ## Function to run louvain clustering multiple times and calculate ARI
    calculate_rand_index <- function(seu_object, par_FindClusters_resolution, OUT_DIR) {
        mybiglist <- list()
        means <- list()
        standard_devs <- list()
        result <- list()
        reps = par_RI_reps
        for(i in par_FindClusters_resolution) { 
            for(n in 1:reps) { 
            seu_object <- Seurat::FindClusters(seu_int, resolution = i, random.seed = n) 
            # retrieve the clustering
            column <- paste0(par_whatAssay,"_snn_res.",i)
            df <- data.frame(seu_object@meta.data)
            df1 <- df %>% select(column)
            result[[n]] <- df1[,1]
            }
            mybiglist <- list()
            for (f in 1:length(result)){
            for (j in 1:length(result)){
                if (f==j) {
                name <- paste0(f, ",", j)
                tmp <- -5  
                mybiglist[[name]] <- tmp
                mybiglist
                } else {
                name <- paste0(f, ",", j)
                tmp <- adj.rand.index(result[[f]], result[[j]])
                mybiglist[[name]] <- tmp
                mybiglist
                }
            }
            }
            mybiglist_test <-  mybiglist[mybiglist != -5]
            
            mean <- mean(unlist((mybiglist_test)))
            sd <- sd(unlist((mybiglist_test)))
            means[[paste0("mean_",i)]] <- mean                           
            standard_devs[[paste0("sd_",i)]] <- sd                            
        }
        ## standard deviation
        # plot standard deviation
        sd_df<- data.frame(standard_devs)
        sd_df<- data.frame(t(sd_df))
        sd_df$resolution <- rownames(sd_df)
        colnames(sd_df) <- c("sd", "Resolution")
        sd_df$group = "group"
        sd_plot <- ggplot(sd_df, aes(x = Resolution, y = sd, group = group)) +
            geom_line() + geom_point() + theme_bw() +
            theme(axis.text.x = element_blank(),
                axis.title.x = element_blank(),
                axis.ticks.x = element_blank()) +
                ylab("SD ARI")
        ## means
        # plot means
        sd_mean<- data.frame(means)
        sd_mean<- data.frame(t(sd_mean))
        sd_mean$resolution <- rownames(sd_mean)
        colnames(sd_mean) <- c("mean", "Resolution")
        sd_mean$group = "group"
        mean_plot <- ggplot(sd_mean, aes(x = Resolution, y = mean, group = group)) +
            geom_line() + geom_point() + theme_bw() +
            theme(axis.text.x = element_blank(),
                axis.title.x = element_blank(),
                axis.ticks.x = element_blank()) +
                ylab("Mean ARI")

        ## arrange plots
        ggarrange(mean_plot, sd_plot, ncol = 1, nrow = 2)
        # Combine standard deviation and means list
        list3 <- c(means,standard_devs)
        list3_df <- data.frame(list3)
        list3_df
        # Write excel file
        if(file.exists(paste(OUT_DIR, "/clustering_ARI.xlsx", sep=''))){
            file.remove(paste(OUT_DIR, "/clustering_ARI.xlsx", sep=''))
        }
        write.xlsx(list3_df, paste(OUT_DIR, "/clustering_ARI.xlsx", sep='')) 
        plots <- ggarrange(mean_plot, sd_plot, ncol = 1, nrow = 2, align = "hv")
        plots
    }  

    ## Compute standard deviation and mean of ARI at different clustering resolutions
    test_plot <- calculate_rand_index(seu_int,par_FindClusters_resolution, OUT_DIR ) 

    ## function to plot ARI information and cluster resolution together
    calculate_clusters<- function(seu_int, par_FindClusters_resolution, test_plot, OUT_DIR) {
        mybiglist <- list()
        for(i in par_FindClusters_resolution) { 
            column <- paste0(par_whatAssay,"_snn_res.",i)
            df <- data.frame(seu_int@meta.data)
            df1 <- df %>% select(column)
            n_levels <-length(unique(df1[,1]))
            mybiglist[[column]] <- n_levels
        }
        mybiglist
        sd_df<- data.frame(mybiglist)
        sd_df<- data.frame(t(sd_df))
        sd_df$resolution <- rownames(sd_df)
        colnames(sd_df) <- c("cluster", "Resolution")
        sd_df$group = "group"
        cluster_plot <- ggplot(sd_df, aes(x = Resolution, y = cluster, group = group)) +
            geom_line() +
            geom_point() +
            theme_bw() +
            theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
            ylab("Number of clusters")
        ggarrange(test_plot, cluster_plot, ncol = 1, nrow = 2, heights = c(1.25,1))
        ggsave(file = paste(OUT_DIR, "/ARI.pdf", sep=''))
    }  

    ## produce final plot
    calculate_clusters(seu_int, par_FindClusters_resolution, test_plot, OUT_DIR) 
##

############################################
# Integrate DaN object across timepoints #
############################################
## code
    output_dir <- "~/ensemblux_manuscript/Figure5"
    seu_11_integrated<-readRDS('~/ensemblux_manuscript/Figure5/None_d11_all/pool5_integrated_seurat_none.rds')
    unique(seu_11_integrated@meta.data$Sample_ID)
    seu_30_integrated<-readRDS('~/ensemblux_manuscript/Figure5/None_d30_all/pool5_integrated_seurat_none.rds')
    unique(seu_30_integrated@meta.data$Sample_ID)
    seu_52_integrated<-readRDS('~/ensemblux_manuscript/Figure5/None_d52_all/pool5_integrated_seurat_none_2.rds')
    unique(seu_52_integrated@meta.data$Sample_ID)

    seu_list <- list(seu_11_integrated = seu_11_integrated, 
                        seu_30_integrated = seu_30_integrated, 
                        seu_52_integrated = seu_52_integrated)
    
    ## Select inetgration features
    features <- Seurat::SelectIntegrationFeatures(object.list = seu_list, nfeatures = 3000)

    ## Find integration anchors
    seu_anchors <- Seurat::FindIntegrationAnchors(object.list = seu_list, dims = 1:50, anchor.features = features)

    ## Integrate Seurat objects
    seu_int <- Seurat::IntegrateData(anchorset = seu_anchors,dims = 1:50)
    saveRDS(seu_int, paste(output_dir,"/pool5_seurat_integrated_all_timepoints.rds", sep=""))
##

####################################################
# Print UMAP showing ambiguous singlet assignments #
####################################################
## code
    ## Read in Seurat object
    seu_int<-readRDS("~/ensemblux_manuscript/Figure5/pool5_seurat_integrated_all_timepoints.rds.rds")
    output_dir <- "~/ensemblux_manuscript/Figure5"

    ## Set default assay to integrated
    Seurat::DefaultAssay(seu_int) <- "integrated"

    ## Scale integrated Seurat object
    seu_int <- ScaleData(seu_int, verbose = FALSE)

    ## Run PCA and UMAP on integrated Seurat object
    seu_int <- RunPCA(seu_int, npcs = 50, verbose = FALSE)
    seu_int <- RunUMAP(seu_int, dims = 1:50, n.neighbors =10)

    ## Print PCA
    DimPlot(seu_int, reduction = "pca", group.by="Sample_ID", raster = FALSE )

    ## Print elbow plot
    ElbowPlot(seu_int, ndims = 50)  

    ## print UMAP
    DimPlot(seu_int, reduction = "umap", group.by="Sample_ID", raster = FALSE )

    ## Make Seurat object metadata datframe
    df <- data.frame(seu_int@meta.data)

    ### Add evaluation columns
    ## Ensemblux
    df$ensemblux_eval <- "no"
    df$ensemblux_eval[df$Ensemblux_assignment == "unassigned"] <- "yes"
    ## Demuxlet
    df$demuxlet_eval <- "no"
    df$demuxlet_eval[df$demuxlet_assignment == "unassigned" & df$demuxlet_best_assignment != "doublet" ] <- "yes"
    ## Demuxalot
    df$demuxalotx_eval <- "no"
    df$demuxalotx_eval[df$demuxalot_assignment == "unassigned" & df$demuxalot_best_assignment != "doublet"  ] <- "yes"
    ## Vireo
    df$vireo_eval <- "no"
    df$vireo_eval[df$vireo_assignment == "unassigned" & df$vireo_best_assignment != "doublet" ] <- "yes"
    ## Souporcell
    df$souporcell_eval <- "no"
    df$souporcell_eval[df$souporcell_assignment == "unassigned" & df$souporcell_best_assignment != "doublet" ] <- "yes"

    ## Add new metadata back to Seurat object 
    df <- df %>% dplyr::select(ensemblux_eval, demuxlet_eval, demuxalotx_eval, vireo_eval, souporcell_eval)
    seu_int <- AddMetaData(seu_int, df)

    ### Print tool-specific UMAPs
    ## Demuxlet
    DimPlot(seu_int, reduction = "umap", group.by="demuxlet_eval", raster = FALSE ) + scale_colour_manual(values = c("lightsteelblue1", "red")) + theme_void()
    ## Ensemblux
    DimPlot(seu_int, reduction = "umap", group.by="ensemblux_eval", raster = FALSE ) + scale_colour_manual(values = c("lightsteelblue1", "red")) + theme_void()
    ## Demuxalot
    DimPlot(seu_int, reduction = "umap", group.by="demuxalotx_eval", raster = FALSE) + scale_colour_manual(values = c("lightsteelblue1", "red")) + theme_void()
    ## Vireo
    DimPlot(seu_int, reduction = "umap", group.by="vireo_eval", raster = FALSE ) + scale_colour_manual(values = c("lightsteelblue1", "red")) + theme_void()
    ## Souporcell
    DimPlot(seu_int, reduction = "umap", group.by="souporcell_eval", raster = FALSE ) + scale_colour_manual(values = c("lightsteelblue1", "red")) + theme_void()
##

#################################################################
# Compute proportion of confident/ambiguous singlet assignments #
#################################################################
## code
    ## Read in Ensemblux output    
    ## D11
    # Rep 1
    d11_rep1 <- read.delim("~/jerber_pool5/day_11/rep1/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(d11_rep1) <- paste0("pool5_day_11_rep1_", d11_rep1$barcode)
    rownames(d11_rep1) %in% rownames(df)
    # Rep 2
    d11_rep2 <- read.delim("~/jerber_pool5/day_11/rep2/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(d11_rep2) <- paste0("pool5_day_11_rep2_", d11_rep2$barcode)
    rownames(d11_rep2) %in% rownames(df)
    # Rep 3
    d11_rep3 <- read.delim("~/jerber_pool5/day_11/rep3/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(d11_rep3) <- paste0("pool5_day_11_rep3_", d11_rep3$barcode)
    rownames(d11_rep3) %in% rownames(df)

    ## D30
    # Rep 1
    d30_rep1 <- read.delim("~/jerber_pool5/day_30/rep1/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(d30_rep1) <- paste0("pool5_day_30_rep1_", d30_rep1$barcode)
    rownames(d30_rep1) %in% rownames(df)
    # Rep 2
    d30_rep2 <- read.delim("~/jerber_pool5/day_30/rep2/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(d30_rep2) <- paste0("pool5_day_30_rep2_", d30_rep2$barcode)
    rownames(d30_rep2) %in% rownames(df)
    # Rep 1
    d30_rep3 <- read.delim("~/jerber_pool5/day_30/rep3/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(d30_rep3) <- paste0("pool5_day_30_rep3_", d30_rep3$barcode)
    rownames(d30_rep3) %in% rownames(df)

    ## D52
    # Rep 1
    d52_rep1 <- read.delim("~/jerber_pool5/day_52ctrl/rep1/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(d52_rep1) <- paste0("pool5_day_52ctrl_rep1_", d52_rep1$barcode)
    rownames(d52_rep1) %in% rownames(df)
    # Rep 2
    d52_rep2 <- read.delim("~/jerber_pool5/day_52ctrl/rep2/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(d52_rep2) <- paste0("pool5_day_52ctrl_rep2_", d52_rep2$barcode)
    rownames(d52_rep2) %in% rownames(df)
    # Rep 3
    d52_rep3 <- read.delim("~/jerber_pool5/day_52ctrl/rep3/Ensemblux/confidence/confidence_PWE_GBD_EID_droplet_assignment.csv", header = T, sep = ",")
    rownames(d52_rep3) <- paste0("pool5_day_52ctrl_rep3_", d52_rep3$barcode)
    rownames(d52_rep3) %in% rownames(df)
    ################################################
    ## Ensemblux
    ################################################
    ## code
        ## D11 
        # R1
        d11_rep1_n <- nrow(d11_rep1)
        d11_rep1$ensemblux_eval <- "no"
        d11_rep1$ensemblux_eval[d11_rep1$Ensemblux_assignment == "unassigned"] <- "yes"
        d_11_ensemblux <- subset(d11_rep1, ensemblux_eval == "no")
        d_11_ensemblux <- nrow(d_11_ensemblux)
        d_11_ensemblux_1 <- d_11_ensemblux
        d_11_ensemblux_r1 <- d_11_ensemblux/d11_rep1_n
        
        d11_rep1_singlet <- subset(d11_rep1, Ensemblux_best_assignment != "doublet" )
        d11_rep1_singlet <- nrow(d11_rep1_singlet)
        d11_rep1_unassigned <- subset(d11_rep1, ensemblux_eval == "yes")
        d11_rep1_unassigned <- nrow(d11_rep1_unassigned)
        d_11_ensemblux_r1_singlet <- 1- ((d11_rep1_unassigned)/d11_rep1_singlet)

        # R2
        d11_rep2_n <- nrow(d11_rep2)
        d11_rep2$ensemblux_eval <- "no"
        d11_rep2$ensemblux_eval[d11_rep2$Ensemblux_assignment == "unassigned"] <- "yes"
        d_11_ensemblux <- subset(d11_rep2, ensemblux_eval == "no")
        d_11_ensemblux <- nrow(d_11_ensemblux)
        d_11_ensemblux_2 <- d_11_ensemblux
        d_11_ensemblux_r2 <- d_11_ensemblux/d11_rep2_n

        d11_rep2_singlet <- subset(d11_rep2, Ensemblux_best_assignment != "doublet" )
        d11_rep2_singlet <- nrow(d11_rep2_singlet)
        d11_rep2_unassigned <- subset(d11_rep2, ensemblux_eval == "yes")
        d11_rep2_unassigned <- nrow(d11_rep2_unassigned)
        d_11_ensemblux_r2_singlet <- 1- ((d11_rep2_unassigned)/d11_rep2_singlet)

        # R3
        d11_rep3_n <- nrow(d11_rep3)
        d11_rep3$ensemblux_eval <- "no"
        d11_rep3$ensemblux_eval[d11_rep3$Ensemblux_assignment == "unassigned"] <- "yes"
        d_11_ensemblux <- subset(d11_rep3, ensemblux_eval == "no")
        d_11_ensemblux <- nrow(d_11_ensemblux)
        d_11_ensemblux_3 <- d_11_ensemblux
        d_11_ensemblux_r3 <- d_11_ensemblux/d11_rep3_n

        d11_rep3_singlet <- subset(d11_rep3, Ensemblux_best_assignment != "doublet" )
        d11_rep3_singlet <- nrow(d11_rep3_singlet)
        d11_rep3_unassigned <- subset(d11_rep3, ensemblux_eval == "yes")
        d11_rep3_unassigned <- nrow(d11_rep3_unassigned)
        d_11_ensemblux_r3_singlet <- 1- ((d11_rep3_unassigned)/d11_rep3_singlet)

        ## D30
        # R1
        d30_rep1_n <- nrow(d30_rep1)
        d30_rep1$ensemblux_eval <- "no"
        d30_rep1$ensemblux_eval[d30_rep1$Ensemblux_assignment == "unassigned"] <- "yes"
        d_30_ensemblux <- subset(d30_rep1, ensemblux_eval == "no")
        d_30_ensemblux <- nrow(d_30_ensemblux)
        d_30_ensemblux_1 <- d_30_ensemblux
        d_30_ensemblux_r1 <- d_30_ensemblux/d30_rep1_n
        
        d30_rep1_singlet <- subset(d30_rep1, Ensemblux_best_assignment != "doublet" )
        d30_rep1_singlet <- nrow(d30_rep1_singlet)
        d30_rep1_unassigned <- subset(d30_rep1, ensemblux_eval == "yes")
        d30_rep1_unassigned <- nrow(d30_rep1_unassigned)
        d_30_ensemblux_r1_singlet <- 1- ((d30_rep1_unassigned)/d30_rep1_singlet)
        
        # R2
        d30_rep2_n <- nrow(d30_rep2)
        d30_rep2$ensemblux_eval <- "no"
        d30_rep2$ensemblux_eval[d30_rep2$Ensemblux_assignment == "unassigned"] <- "yes"
        d_30_ensemblux <- subset(d30_rep2, ensemblux_eval == "no")
        d_30_ensemblux <- nrow(d_30_ensemblux)
        d_30_ensemblux_2 <- d_30_ensemblux
        d_30_ensemblux_r2 <- d_30_ensemblux/d30_rep2_n

        d30_rep2_singlet <- subset(d30_rep2, Ensemblux_best_assignment != "doublet" )
        d30_rep2_singlet <- nrow(d30_rep2_singlet)
        d30_rep2_unassigned <- subset(d30_rep2, ensemblux_eval == "yes")
        d30_rep2_unassigned <- nrow(d30_rep2_unassigned)
        d_30_ensemblux_r2_singlet <- 1- ((d30_rep2_unassigned)/d30_rep2_singlet)

        # R3
        d30_rep3_n <- nrow(d30_rep3)
        d30_rep3$ensemblux_eval <- "no"
        d30_rep3$ensemblux_eval[d30_rep3$Ensemblux_assignment == "unassigned"] <- "yes"
        d_30_ensemblux <- subset(d30_rep3, ensemblux_eval == "no")
        d_30_ensemblux <- nrow(d_30_ensemblux)
        d_30_ensemblux_3 <- d_30_ensemblux
        d_30_ensemblux_r3 <- d_30_ensemblux/d30_rep3_n

        d30_rep3_singlet <- subset(d30_rep3, Ensemblux_best_assignment != "doublet" )
        d30_rep3_singlet <- nrow(d30_rep3_singlet)
        d30_rep3_unassigned <- subset(d30_rep3, ensemblux_eval == "yes")
        d30_rep3_unassigned <- nrow(d30_rep3_unassigned)
        d_30_ensemblux_r3_singlet <- 1- ((d30_rep3_unassigned)/d30_rep3_singlet)

        ## D52
        # R1
        d52_rep1_n <- nrow(d52_rep1)
        d52_rep1$ensemblux_eval <- "no"
        d52_rep1$ensemblux_eval[d52_rep1$Ensemblux_assignment == "unassigned"] <- "yes"
        d_52_ensemblux <- subset(d52_rep1, ensemblux_eval == "no")
        d_52_ensemblux <- nrow(d_52_ensemblux)
        d_52_ensemblux_1 <- d_52_ensemblux
        d_52_ensemblux_r1 <- d_52_ensemblux/d52_rep1_n

        d52_rep1_singlet <- subset(d52_rep1, Ensemblux_best_assignment != "doublet" )
        d52_rep1_singlet <- nrow(d52_rep1_singlet)
        d52_rep1_unassigned <- subset(d52_rep1, ensemblux_eval == "yes")
        d52_rep1_unassigned <- nrow(d52_rep1_unassigned)
        d_52_ensemblux_r1_singlet <- 1- ((d52_rep1_unassigned)/d52_rep1_singlet)
        # R2
        d52_rep2_n <- nrow(d52_rep2)
        d52_rep2$ensemblux_eval <- "no"
        d52_rep2$ensemblux_eval[d52_rep2$Ensemblux_assignment == "unassigned"] <- "yes"
        d_52_ensemblux <- subset(d52_rep2, ensemblux_eval == "no")
        d_52_ensemblux <- nrow(d_52_ensemblux)
        d_52_ensemblux_2 <- d_52_ensemblux
        d_52_ensemblux_r2 <- d_52_ensemblux/d52_rep2_n

        d52_rep2_singlet <- subset(d52_rep2, Ensemblux_best_assignment != "doublet" )
        d52_rep2_singlet <- nrow(d52_rep2_singlet)
        d52_rep2_unassigned <- subset(d52_rep2, ensemblux_eval == "yes")
        d52_rep2_unassigned <- nrow(d52_rep2_unassigned)
        d_52_ensemblux_r2_singlet <- 1- ((d52_rep2_unassigned)/d52_rep2_singlet)

        # R3
        d52_rep3_n <- nrow(d52_rep3)
        d52_rep3$ensemblux_eval <- "no"
        d52_rep3$ensemblux_eval[d52_rep3$Ensemblux_assignment == "unassigned"] <- "yes"
        d_52_ensemblux <- subset(d52_rep3, ensemblux_eval == "no")
        d_52_ensemblux <- nrow(d_52_ensemblux)
        d_52_ensemblux_3 <- d_52_ensemblux
        d_52_ensemblux_r3 <- d_52_ensemblux/d52_rep3_n

        d52_rep3_singlet <- subset(d52_rep3, Ensemblux_best_assignment != "doublet" )
        d52_rep3_singlet <- nrow(d52_rep3_singlet)
        d52_rep3_unassigned <- subset(d52_rep3, ensemblux_eval == "yes")
        d52_rep3_unassigned <- nrow(d52_rep3_unassigned)
        d_52_ensemblux_r3_singlet <- 1- ((d52_rep3_unassigned)/d52_rep3_singlet)

        d_11_temp <- c(d11_rep1_unassigned + d11_rep2_unassigned + d11_rep3_unassigned)
        d_30_temp <- c(d30_rep1_unassigned + d30_rep2_unassigned + d30_rep3_unassigned)
        d_52_temp <- c(d52_rep1_unassigned + d52_rep2_unassigned + d52_rep3_unassigned)
        d_30_prop_temp  <- d_30_temp/(d_11_temp+ d_30_temp+ d_52_temp)
        d_30_prop_temp

        ## bind
        #D11 
        total <- d11_rep1_n + d11_rep2_n + d11_rep3_n
        assigned <- d_11_ensemblux_1 + d_11_ensemblux_2 + d_11_ensemblux_3 
        d_11_prop <- assigned/total
        #D30 
        total <- d30_rep1_n + d30_rep2_n + d30_rep3_n
        assigned <- d_30_ensemblux_1 + d_30_ensemblux_2 + d_30_ensemblux_3 
        d_30_prop <- assigned/total
        #D52
        total <- d52_rep1_n + d52_rep2_n + d52_rep3_n 
        assigned <- d_52_ensemblux_1 + d_52_ensemblux_2 + d_52_ensemblux_3
        d_52_prop <- assigned/total

        bind <- data.frame(prop = c(d_11_prop,d_30_prop,d_52_prop  ), day = c("11", "30", "52"))
        bind$assigned <- bind$prop
        bind$unassigned <- 1 - bind$prop

        ## long format
        bind_df_long <- gather(bind, class, measurement, unassigned:assigned, factor_key=TRUE)
        bind_df_long$day <- factor(bind_df_long$day, levels = c("52", "30", "11"))

        ggplot(bind_df_long, aes(y = day, x = measurement, fill = class)) +geom_bar(stat = 'identity') + theme_classic() + 
            theme(axis.title = element_blank(), 
            legend.position = "none",
            axis.text.y = element_text(face = "bold", colour = "black", size = 12),
            axis.text.x = element_text(colour = "black", size = 12),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank()) +
            scale_fill_manual(values = c("red", "lightsteelblue1")) +
            scale_y_discrete(labels = c("D52", "D30", "D11")) +
            scale_x_continuous(expand= c(0,0), breaks = c(0, 0.5, 1), labels = c('0', '0.5', '1'))
        ggsave(paste(output_dir,"/prop_ensemblux.pdf", sep=""), width = 2.25, height = 1)
    ##
    ################################################
    ## Demuxlet
    ################################################
    ## code
        ## D11 
        # R1
        d11_rep1_n <- nrow(d11_rep1)
        d11_rep1$demuxlet_eval <- "no"
        d11_rep1$demuxlet_eval[d11_rep1$demuxlet_assignment == "unassigned"] <- "yes"
        d_11_demuxlet <- subset(d11_rep1, demuxlet_eval == "no")
        d_11_demuxlet <- nrow(d_11_demuxlet)
        d_11_demuxlet_1 <- d_11_demuxlet
        d_11_demuxlet_r1 <- d_11_demuxlet/d11_rep1_n

        d11_rep1_singlet <- subset(d11_rep1, demuxlet_best_assignment != "doublet" )
        d11_rep1_singlet <- nrow(d11_rep1_singlet)
        d11_rep1_unassigned <- subset(d11_rep1, demuxlet_eval == "yes")
        d11_rep1_unassigned <- nrow(d11_rep1_unassigned)
        d_11_demuxlet_r1_singlet <- 1- ((d11_rep1_unassigned)/d11_rep1_singlet)

        # R2
        d11_rep2_n <- nrow(d11_rep2)
        d11_rep2$demuxlet_eval <- "no"
        d11_rep2$demuxlet_eval[d11_rep2$demuxlet_assignment == "unassigned"] <- "yes"
        d_11_demuxlet <- subset(d11_rep2, demuxlet_eval == "no")
        d_11_demuxlet <- nrow(d_11_demuxlet)
        d_11_demuxlet_2 <- d_11_demuxlet
        d_11_demuxlet_r2 <- d_11_demuxlet/d11_rep2_n

        d11_rep2_singlet <- subset(d11_rep2, demuxlet_best_assignment != "doublet" )
        d11_rep2_singlet <- nrow(d11_rep2_singlet)
        d11_rep2_unassigned <- subset(d11_rep2, demuxlet_eval == "yes")
        d11_rep2_unassigned <- nrow(d11_rep2_unassigned)
        d_11_demuxlet_r2_singlet <- 1- ((d11_rep2_unassigned)/d11_rep2_singlet)

        # R3
        d11_rep3_n <- nrow(d11_rep3)
        d11_rep3$demuxlet_eval <- "no"
        d11_rep3$demuxlet_eval[d11_rep3$demuxlet_assignment == "unassigned"] <- "yes"
        d_11_demuxlet <- subset(d11_rep3, demuxlet_eval == "no")
        d_11_demuxlet <- nrow(d_11_demuxlet)
        d_11_demuxlet_3 <- d_11_demuxlet
        d_11_demuxlet_r3 <- d_11_demuxlet/d11_rep3_n

        d11_rep3_singlet <- subset(d11_rep3, demuxlet_best_assignment != "doublet" )
        d11_rep3_singlet <- nrow(d11_rep3_singlet)
        d11_rep3_unassigned <- subset(d11_rep3, demuxlet_eval == "yes")
        d11_rep3_unassigned <- nrow(d11_rep3_unassigned)
        d_11_demuxlet_r3_singlet <- 1- ((d11_rep3_unassigned)/d11_rep3_singlet)

        ## D30
        # R1
        d30_rep1_n <- nrow(d30_rep1)
        d30_rep1$demuxlet_eval <- "no"
        d30_rep1$demuxlet_eval[d30_rep1$demuxlet_assignment == "unassigned"] <- "yes"
        d_30_demuxlet <- subset(d30_rep1, demuxlet_eval == "no")
        d_30_demuxlet <- nrow(d_30_demuxlet)
        d_30_demuxlet_1 <- d_30_demuxlet
        d_30_demuxlet_r1 <- d_30_demuxlet/d30_rep1_n

        d30_rep1_singlet <- subset(d30_rep1, demuxlet_best_assignment != "doublet" )
        d30_rep1_singlet <- nrow(d30_rep1_singlet)
        d30_rep1_unassigned <- subset(d30_rep1, demuxlet_eval == "yes")
        d30_rep1_unassigned <- nrow(d30_rep1_unassigned)
        d_30_demuxlet_r1_singlet <- 1- ((d30_rep1_unassigned)/d30_rep1_singlet)

        # R2
        d30_rep2_n <- nrow(d30_rep2)
        d30_rep2$demuxlet_eval <- "no"
        d30_rep2$demuxlet_eval[d30_rep2$demuxlet_assignment == "unassigned"] <- "yes"
        d_30_demuxlet <- subset(d30_rep2, demuxlet_eval == "no")
        d_30_demuxlet <- nrow(d_30_demuxlet)
        d_30_demuxlet_2 <- d_30_demuxlet
        d_30_demuxlet_r2 <- d_30_demuxlet/d30_rep2_n

        d30_rep2_singlet <- subset(d30_rep2, demuxlet_best_assignment != "doublet" )
        d30_rep2_singlet <- nrow(d30_rep2_singlet)
        d30_rep2_unassigned <- subset(d30_rep2, demuxlet_eval == "yes")
        d30_rep2_unassigned <- nrow(d30_rep2_unassigned)
        d_30_demuxlet_r2_singlet <- 1- ((d30_rep2_unassigned)/d30_rep2_singlet)

        # R3
        d30_rep3_n <- nrow(d30_rep3)
        d30_rep3$demuxlet_eval <- "no"
        d30_rep3$demuxlet_eval[d30_rep3$demuxlet_assignment == "unassigned"] <- "yes"
        d_30_demuxlet <- subset(d30_rep3, demuxlet_eval == "no")
        d_30_demuxlet <- nrow(d_30_demuxlet)
        d_30_demuxlet_3 <- d_30_demuxlet
        d_30_demuxlet_r3 <- d_30_demuxlet/d30_rep3_n

        d30_rep3_singlet <- subset(d30_rep3, demuxlet_best_assignment != "doublet" )
        d30_rep3_singlet <- nrow(d30_rep3_singlet)
        d30_rep3_unassigned <- subset(d30_rep3, demuxlet_eval == "yes")
        d30_rep3_unassigned <- nrow(d30_rep3_unassigned)
        d_30_demuxlet_r3_singlet <- 1- ((d30_rep3_unassigned)/d30_rep3_singlet)

        ## D52
        # R1
        d52_rep1_n <- nrow(d52_rep1)
        d52_rep1$demuxlet_eval <- "no"
        d52_rep1$demuxlet_eval[d52_rep1$demuxlet_assignment == "unassigned"] <- "yes"
        d_52_demuxlet <- subset(d52_rep1, demuxlet_eval == "no")
        d_52_demuxlet <- nrow(d_52_demuxlet)
        d_52_demuxlet_1 <- d_52_demuxlet
        d_52_demuxlet_r1 <- d_52_demuxlet/d52_rep1_n

        d52_rep1_singlet <- subset(d52_rep1, demuxlet_best_assignment != "doublet" )
        d52_rep1_singlet <- nrow(d52_rep1_singlet)
        d52_rep1_unassigned <- subset(d52_rep1, demuxlet_eval == "yes")
        d52_rep1_unassigned <- nrow(d52_rep1_unassigned)
        d_52_demuxlet_r1_singlet <- 1- ((d52_rep1_unassigned)/d52_rep1_singlet)

        # R2
        d52_rep2_n <- nrow(d52_rep2)
        d52_rep2$demuxlet_eval <- "no"
        d52_rep2$demuxlet_eval[d52_rep2$demuxlet_assignment == "unassigned"] <- "yes"
        d_52_demuxlet <- subset(d52_rep2, demuxlet_eval == "no")
        d_52_demuxlet <- nrow(d_52_demuxlet)
        d_52_demuxlet_2 <- d_52_demuxlet
        d_52_demuxlet_r2 <- d_52_demuxlet/d52_rep2_n

        d52_rep2_singlet <- subset(d52_rep2, demuxlet_best_assignment != "doublet" )
        d52_rep2_singlet <- nrow(d52_rep2_singlet)
        d52_rep2_unassigned <- subset(d52_rep2, demuxlet_eval == "yes")
        d52_rep2_unassigned <- nrow(d52_rep2_unassigned)
        d_52_demuxlet_r2_singlet <- 1- ((d52_rep2_unassigned)/d52_rep2_singlet)

        # R3
        d52_rep3_n <- nrow(d52_rep3)
        d52_rep3$demuxlet_eval <- "no"
        d52_rep3$demuxlet_eval[d52_rep3$demuxlet_assignment == "unassigned"] <- "yes"
        d_52_demuxlet <- subset(d52_rep3, demuxlet_eval == "no")
        d_52_demuxlet <- nrow(d_52_demuxlet)
        d_52_demuxlet_3 <- d_52_demuxlet
        d_52_demuxlet_r3 <- d_52_demuxlet/d52_rep3_n

        d52_rep3_singlet <- subset(d52_rep3, demuxlet_best_assignment != "doublet" )
        d52_rep3_singlet <- nrow(d52_rep3_singlet)
        d52_rep3_unassigned <- subset(d52_rep3, demuxlet_eval == "yes")
        d52_rep3_unassigned <- nrow(d52_rep3_unassigned)
        d_52_demuxlet_r3_singlet <- 1- ((d52_rep3_unassigned)/d52_rep3_singlet)

        
        d_11_temp <- c(d11_rep1_unassigned + d11_rep2_unassigned + d11_rep3_unassigned)
        d_30_temp <- c(d30_rep1_unassigned + d30_rep2_unassigned + d30_rep3_unassigned)
        d_52_temp <- c(d52_rep1_unassigned + d52_rep2_unassigned + d52_rep3_unassigned)
        d_30_prop_temp  <- d_30_temp/(d_11_temp+ d_30_temp+ d_52_temp)
        d_30_prop_temp

        ## bind
        #D11 
        total <- d11_rep1_n + d11_rep2_n + d11_rep3_n
        assigned <- d_11_demuxlet_1 + d_11_demuxlet_2 + d_11_demuxlet_3 
        d_11_prop <- assigned/total
        #D30 
        total <- d30_rep1_n + d30_rep2_n + d30_rep3_n
        assigned <- d_30_demuxlet_1 + d_30_demuxlet_2 + d_30_demuxlet_3 
        d_30_prop <- assigned/total
        #D52
        total <- d52_rep1_n + d52_rep2_n + d52_rep3_n 
        assigned <- d_52_demuxlet_1 + d_52_demuxlet_2 + d_52_demuxlet_3
        d_52_prop <- assigned/total

        bind <- data.frame(prop = c(d_11_prop,d_30_prop,d_52_prop  ), day = c("11", "30", "52"))
        bind$assigned <- bind$prop
        bind$unassigned <- 1 - bind$prop

        ## long format
        bind_df_long <- gather(bind, class, measurement, unassigned:assigned, factor_key=TRUE)
        bind_df_long$day <- factor(bind_df_long$day, levels = c("52", "30", "11"))

        ggplot(bind_df_long, aes(y = day, x = measurement, fill = class)) +geom_bar(stat = 'identity') + theme_classic() + 
            theme(axis.title = element_blank(), 
            legend.position = "none",
            axis.text.y = element_text(face = "bold", colour = "black", size = 12),
            axis.text.x = element_text(colour = "black", size = 12),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank()) +
            scale_fill_manual(values = c("red", "lightsteelblue1")) +
            scale_y_discrete(labels = c("D52", "D30", "D11")) +
            scale_x_continuous(expand= c(0,0), breaks = c(0, 0.5, 1), labels = c('0', '0.5', '1'))
        ggsave(paste(output_dir,"/prop_demuxlet.pdf", sep=""), width = 2.25, height = 1)
    ##
    ################################################
    ## Demuxalot
    ################################################
    ## code
        ## D11 
        # R1
        d11_rep1_n <- nrow(d11_rep1)
        d11_rep1$demuxalot_eval <- "no"
        d11_rep1$demuxalot_eval[d11_rep1$demuxalot_assignment == "unassigned" & d11_rep1$demuxalot_best_assignment != "doublet"] <- "yes"
        d_11_demuxalot <- subset(d11_rep1, demuxalot_eval == "no")
        d_11_demuxalot <- nrow(d_11_demuxalot)
        d_11_demuxalot_1 <- d_11_demuxalot
        d_11_demuxalot_r1 <- d_11_demuxalot/d11_rep1_n

        d11_rep1_singlet <- subset(d11_rep1, demuxalot_best_assignment != "doublet" )
        d11_rep1_singlet <- nrow(d11_rep1_singlet)
        d11_rep1_unassigned <- subset(d11_rep1, demuxalot_eval == "yes")
        d11_rep1_unassigned <- nrow(d11_rep1_unassigned)
        d_11_demuxalot_r1_singlet <- 1- ((d11_rep1_unassigned)/d11_rep1_singlet)

        # R2
        d11_rep2_n <- nrow(d11_rep2)
        d11_rep2$demuxalot_eval <- "no"
        d11_rep2$demuxalot_eval[d11_rep2$demuxalot_assignment == "unassigned" & d11_rep2$demuxalot_best_assignment != "doublet"] <- "yes"
        d_11_demuxalot <- subset(d11_rep2, demuxalot_eval == "no")
        d_11_demuxalot <- nrow(d_11_demuxalot)
        d_11_demuxalot_2 <- d_11_demuxalot
        d_11_demuxalot_r2 <- d_11_demuxalot/d11_rep2_n

        d11_rep2_singlet <- subset(d11_rep2, demuxalot_best_assignment != "doublet" )
        d11_rep2_singlet <- nrow(d11_rep2_singlet)
        d11_rep2_unassigned <- subset(d11_rep2, demuxalot_eval == "yes")
        d11_rep2_unassigned <- nrow(d11_rep2_unassigned)
        d_11_demuxalot_r2_singlet <- 1- ((d11_rep2_unassigned)/d11_rep2_singlet)

        # R3
        d11_rep3_n <- nrow(d11_rep3)
        d11_rep3$demuxalot_eval <- "no"
        d11_rep3$demuxalot_eval[d11_rep3$demuxalot_assignment == "unassigned"& d11_rep3$demuxalot_best_assignment != "doublet"] <- "yes"
        d_11_demuxalot <- subset(d11_rep3, demuxalot_eval == "no")
        d_11_demuxalot <- nrow(d_11_demuxalot)
        d_11_demuxalot_3 <- d_11_demuxalot
        d_11_demuxalot_r3 <- d_11_demuxalot/d11_rep3_n

        d11_rep3_singlet <- subset(d11_rep3, demuxalot_best_assignment != "doublet" )
        d11_rep3_singlet <- nrow(d11_rep3_singlet)
        d11_rep3_unassigned <- subset(d11_rep3, demuxalot_eval == "yes")
        d11_rep3_unassigned <- nrow(d11_rep3_unassigned)
        d_11_demuxalot_r3_singlet <- 1- ((d11_rep3_unassigned)/d11_rep3_singlet)

        ## D30
        # R1
        d30_rep1_n <- nrow(d30_rep1)
        d30_rep1$demuxalot_eval <- "no"
        d30_rep1$demuxalot_eval[d30_rep1$demuxalot_assignment == "unassigned" & d30_rep1$demuxalot_best_assignment != "doublet"] <- "yes"
        d_30_demuxalot <- subset(d30_rep1, demuxalot_eval == "no")
        d_30_demuxalot <- nrow(d_30_demuxalot)
        d_30_demuxalot_1 <- d_30_demuxalot
        d_30_demuxalot_r1 <- d_30_demuxalot/d30_rep1_n

        d30_rep1_singlet <- subset(d30_rep1, demuxalot_best_assignment != "doublet" )
        d30_rep1_singlet <- nrow(d30_rep1_singlet)
        d30_rep1_unassigned <- subset(d30_rep1, demuxalot_eval == "yes")
        d30_rep1_unassigned <- nrow(d30_rep1_unassigned)
        d_30_demuxalot_r1_singlet <- 1- ((d30_rep1_unassigned)/d30_rep1_singlet)
        # R2
        d30_rep2_n <- nrow(d30_rep2)
        d30_rep2$demuxalot_eval <- "no"
        d30_rep2$demuxalot_eval[d30_rep2$demuxalot_assignment == "unassigned" & d30_rep2$demuxalot_best_assignment != "doublet"] <- "yes"
        d_30_demuxalot <- subset(d30_rep2, demuxalot_eval == "no")
        d_30_demuxalot <- nrow(d_30_demuxalot)
        d_30_demuxalot_2 <- d_30_demuxalot
        d_30_demuxalot_r2 <- d_30_demuxalot/d30_rep2_n

        d30_rep2_singlet <- subset(d30_rep2, demuxalot_best_assignment != "doublet" )
        d30_rep2_singlet <- nrow(d30_rep2_singlet)
        d30_rep2_unassigned <- subset(d30_rep2, demuxalot_eval == "yes")
        d30_rep2_unassigned <- nrow(d30_rep2_unassigned)
        d_30_demuxalot_r2_singlet <- 1- ((d30_rep2_unassigned)/d30_rep2_singlet)

        # R3
        d30_rep3_n <- nrow(d30_rep3)
        d30_rep3$demuxalot_eval <- "no"
        d30_rep3$demuxalot_eval[d30_rep3$demuxalot_assignment == "unassigned" & d30_rep3$demuxalot_best_assignment != "doublet"] <- "yes"
        d_30_demuxalot <- subset(d30_rep3, demuxalot_eval == "no")
        d_30_demuxalot <- nrow(d_30_demuxalot)
        d_30_demuxalot_3 <- d_30_demuxalot
        d_30_demuxalot_r3 <- d_30_demuxalot/d30_rep3_n

        d30_rep3_singlet <- subset(d30_rep3, demuxalot_best_assignment != "doublet" )
        d30_rep3_singlet <- nrow(d30_rep3_singlet)
        d30_rep3_unassigned <- subset(d30_rep3, demuxalot_eval == "yes")
        d30_rep3_unassigned <- nrow(d30_rep3_unassigned)
        d_30_demuxalot_r3_singlet <- 1- ((d30_rep3_unassigned)/d30_rep3_singlet)

        ## D52
        # R1
        d52_rep1_n <- nrow(d52_rep1)
        d52_rep1$demuxalot_eval <- "no"
        d52_rep1$demuxalot_eval[d52_rep1$demuxalot_assignment == "unassigned" & d52_rep1$demuxalot_best_assignment != "doublet"] <- "yes"
        d_52_demuxalot <- subset(d52_rep1, demuxalot_eval == "no")
        d_52_demuxalot <- nrow(d_52_demuxalot)
        d_52_demuxalot_1 <- d_52_demuxalot
        d_52_demuxalot_r1 <- d_52_demuxalot/d52_rep1_n

        d52_rep1_singlet <- subset(d52_rep1, demuxalot_best_assignment != "doublet" )
        d52_rep1_singlet <- nrow(d52_rep1_singlet)
        d52_rep1_unassigned <- subset(d52_rep1, demuxalot_eval == "yes")
        d52_rep1_unassigned <- nrow(d52_rep1_unassigned)
        d_52_demuxalot_r1_singlet <- 1- ((d52_rep1_unassigned)/d52_rep1_singlet)

        # R2
        d52_rep2_n <- nrow(d52_rep2)
        d52_rep2$demuxalot_eval <- "no"
        d52_rep2$demuxalot_eval[d52_rep2$demuxalot_assignment == "unassigned" & d52_rep2$demuxalot_best_assignment != "doublet"] <- "yes"
        d_52_demuxalot <- subset(d52_rep2, demuxalot_eval == "no")
        d_52_demuxalot <- nrow(d_52_demuxalot)
        d_52_demuxalot_2 <- d_52_demuxalot
        d_52_demuxalot_r2 <- d_52_demuxalot/d52_rep2_n

        d52_rep2_singlet <- subset(d52_rep2, demuxalot_best_assignment != "doublet" )
        d52_rep2_singlet <- nrow(d52_rep2_singlet)
        d52_rep2_unassigned <- subset(d52_rep2, demuxalot_eval == "yes")
        d52_rep2_unassigned <- nrow(d52_rep2_unassigned)
        d_52_demuxalot_r2_singlet <- 1- ((d52_rep2_unassigned)/d52_rep2_singlet)

        # R3
        d52_rep3_n <- nrow(d52_rep3)
        d52_rep3$demuxalot_eval <- "no"
        d52_rep3$demuxalot_eval[d52_rep3$demuxalot_assignment == "unassigned" & d52_rep3$demuxalot_best_assignment != "doublet"] <- "yes"
        d_52_demuxalot <- subset(d52_rep3, demuxalot_eval == "no")
        d_52_demuxalot <- nrow(d_52_demuxalot)
        d_52_demuxalot_3 <- d_52_demuxalot
        d_52_demuxalot_r3 <- d_52_demuxalot/d52_rep3_n

        d52_rep3_singlet <- subset(d52_rep3, demuxalot_best_assignment != "doublet" )
        d52_rep3_singlet <- nrow(d52_rep3_singlet)
        d52_rep3_unassigned <- subset(d52_rep3, demuxalot_eval == "yes")
        d52_rep3_unassigned <- nrow(d52_rep3_unassigned)
        d_52_demuxalot_r3_singlet <- 1- ((d52_rep3_unassigned)/d52_rep3_singlet)

        d_11_temp <- c(d11_rep1_unassigned + d11_rep2_unassigned + d11_rep3_unassigned)
        d_30_temp <- c(d30_rep1_unassigned + d30_rep2_unassigned + d30_rep3_unassigned)
        d_52_temp <- c(d52_rep1_unassigned + d52_rep2_unassigned + d52_rep3_unassigned)
        d_30_prop_temp  <- d_30_temp/(d_11_temp+ d_30_temp+ d_52_temp)
        d_30_prop_temp

        ## bind
        #D11 
        total <- d11_rep1_n + d11_rep2_n + d11_rep3_n
        assigned <- d_11_demuxalot_1 + d_11_demuxalot_2 + d_11_demuxalot_3 
        d_11_prop <- assigned/total
        #D30 
        total <- d30_rep1_n + d30_rep2_n + d30_rep3_n
        assigned <- d_30_demuxalot_1 + d_30_demuxalot_2 + d_30_demuxalot_3 
        d_30_prop <- assigned/total
        #D52
        total <- d52_rep1_n + d52_rep2_n + d52_rep3_n 
        assigned <- d_52_demuxalot_1 + d_52_demuxalot_2 + d_52_demuxalot_3
        d_52_prop <- assigned/total

        bind <- data.frame(prop = c(d_11_prop,d_30_prop,d_52_prop  ), day = c("11", "30", "52"))
        bind$assigned <- bind$prop
        bind$unassigned <- 1 - bind$prop

        ## long format
        bind_df_long <- gather(bind, class, measurement, unassigned:assigned, factor_key=TRUE)
        bind_df_long$day <- factor(bind_df_long$day, levels = c("52", "30", "11"))

        ggplot(bind_df_long, aes(y = day, x = measurement, fill = class)) +geom_bar(stat = 'identity') + theme_classic() + 
            theme(axis.title = element_blank(), 
            legend.position = "none",
            axis.text.y = element_text(face = "bold", colour = "black", size = 12),
            axis.text.x = element_text(colour = "black", size = 12),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank()) +
            scale_fill_manual(values = c("red", "lightsteelblue1")) +
            scale_y_discrete(labels = c("D52", "D30", "D11")) +
            scale_x_continuous(expand= c(0,0), breaks = c(0, 0.5, 1), labels = c('0', '0.5', '1'))
        ggsave(paste(output_dir,"/prop_demuxalot.pdf", sep=""), width = 2.25, height = 1)
    ##
    ################################################
    ## Vireo
    ################################################
    ## code
        ## D11 
        # R1
        d11_rep1_n <- nrow(d11_rep1)
        d11_rep1$vireo_eval <- "no"
        d11_rep1$vireo_eval[d11_rep1$vireo_assignment == "unassigned" & d11_rep1$vireo_best_assignment != "doublet"] <- "yes"
        d_11_vireo <- subset(d11_rep1, vireo_eval == "no")
        d_11_vireo <- nrow(d_11_vireo)
        d_11_vireo_1 <- d_11_vireo
        d_11_vireo_r1 <- d_11_vireo/d11_rep1_n

        d11_rep1_singlet <- subset(d11_rep1, vireo_best_assignment != "doublet" )
        d11_rep1_singlet <- nrow(d11_rep1_singlet)
        d11_rep1_unassigned <- subset(d11_rep1, vireo_eval == "yes")
        d11_rep1_unassigned <- nrow(d11_rep1_unassigned)
        d_11_vireo_r1_singlet <- 1- ((d11_rep1_unassigned)/d11_rep1_singlet)

        # R2
        d11_rep2_n <- nrow(d11_rep2)
        d11_rep2$vireo_eval <- "no"
        d11_rep2$vireo_eval[d11_rep2$vireo_assignment == "unassigned" & d11_rep2$vireo_best_assignment != "doublet"] <- "yes"
        d_11_vireo <- subset(d11_rep2, vireo_eval == "no")
        d_11_vireo <- nrow(d_11_vireo)
        d_11_vireo_2 <- d_11_vireo
        d_11_vireo_r2 <- d_11_vireo/d11_rep2_n

        d11_rep2_singlet <- subset(d11_rep2, vireo_best_assignment != "doublet" )
        d11_rep2_singlet <- nrow(d11_rep2_singlet)
        d11_rep2_unassigned <- subset(d11_rep2, vireo_eval == "yes")
        d11_rep2_unassigned <- nrow(d11_rep2_unassigned)
        d_11_vireo_r2_singlet <- 1- ((d11_rep2_unassigned)/d11_rep2_singlet)

        # R3
        d11_rep3_n <- nrow(d11_rep3)
        d11_rep3$vireo_eval <- "no"
        d11_rep3$vireo_eval[d11_rep3$vireo_assignment == "unassigned" & d11_rep3$vireo_best_assignment != "doublet"] <- "yes"
        d_11_vireo <- subset(d11_rep3, vireo_eval == "no")
        d_11_vireo <- nrow(d_11_vireo)
        d_11_vireo_3 <- d_11_vireo
        d_11_vireo_r3 <- d_11_vireo/d11_rep3_n

        d11_rep3_singlet <- subset(d11_rep3, vireo_best_assignment != "doublet" )
        d11_rep3_singlet <- nrow(d11_rep3_singlet)
        d11_rep3_unassigned <- subset(d11_rep3, vireo_eval == "yes")
        d11_rep3_unassigned <- nrow(d11_rep3_unassigned)
        d_11_vireo_r3_singlet <- 1- ((d11_rep3_unassigned)/d11_rep3_singlet)

        ## D30
        # R1
        d30_rep1_n <- nrow(d30_rep1)
        d30_rep1$vireo_eval <- "no"
        d30_rep1$vireo_eval[d30_rep1$vireo_assignment == "unassigned" & d30_rep1$vireo_best_assignment != "doublet"] <- "yes"
        d_30_vireo <- subset(d30_rep1, vireo_eval == "no")
        d_30_vireo <- nrow(d_30_vireo)
        d_30_vireo_1 <- d_30_vireo
        d_30_vireo_r1 <- d_30_vireo/d30_rep1_n

        d30_rep1_singlet <- subset(d30_rep1, vireo_best_assignment != "doublet" )
        d30_rep1_singlet <- nrow(d30_rep1_singlet)
        d30_rep1_unassigned <- subset(d30_rep1, vireo_eval == "yes")
        d30_rep1_unassigned <- nrow(d30_rep1_unassigned)
        d_30_vireo_r1_singlet <- 1- ((d30_rep1_unassigned)/d30_rep1_singlet)

        # R2
        d30_rep2_n <- nrow(d30_rep2)
        d30_rep2$vireo_eval <- "no"
        d30_rep2$vireo_eval[d30_rep2$vireo_assignment == "unassigned" & d30_rep2$vireo_best_assignment != "doublet"] <- "yes"
        d_30_vireo <- subset(d30_rep2, vireo_eval == "no")
        d_30_vireo <- nrow(d_30_vireo)
        d_30_vireo_2 <- d_30_vireo
        d_30_vireo_r2 <- d_30_vireo/d30_rep2_n

        d30_rep2_singlet <- subset(d30_rep2, vireo_best_assignment != "doublet" )
        d30_rep2_singlet <- nrow(d30_rep2_singlet)
        d30_rep2_unassigned <- subset(d30_rep2, vireo_eval == "yes")
        d30_rep2_unassigned <- nrow(d30_rep2_unassigned)
        d_30_vireo_r2_singlet <- 1- ((d30_rep2_unassigned)/d30_rep2_singlet)

        # R3
        d30_rep3_n <- nrow(d30_rep3)
        d30_rep3$vireo_eval <- "no"
        d30_rep3$vireo_eval[d30_rep3$vireo_assignment == "unassigned" & d30_rep3$vireo_best_assignment != "doublet"] <- "yes"
        d_30_vireo <- subset(d30_rep3, vireo_eval == "no")
        d_30_vireo <- nrow(d_30_vireo)
        d_30_vireo_3 <- d_30_vireo
        d_30_vireo_r3 <- d_30_vireo/d30_rep3_n

        d30_rep3_singlet <- subset(d30_rep3, vireo_best_assignment != "doublet" )
        d30_rep3_singlet <- nrow(d30_rep3_singlet)
        d30_rep3_unassigned <- subset(d30_rep3, vireo_eval == "yes")
        d30_rep3_unassigned <- nrow(d30_rep3_unassigned)
        d_30_vireo_r3_singlet <- 1- ((d30_rep3_unassigned)/d30_rep3_singlet)

        ## D52
        # R1
        d52_rep1_n <- nrow(d52_rep1)
        d52_rep1$vireo_eval <- "no"
        d52_rep1$vireo_eval[d52_rep1$vireo_assignment == "unassigned" & d52_rep1$vireo_best_assignment != "doublet"] <- "yes"
        d_52_vireo <- subset(d52_rep1, vireo_eval == "no")
        d_52_vireo <- nrow(d_52_vireo)
        d_52_vireo_1 <- d_52_vireo
        d_52_vireo_r1 <- d_52_vireo/d52_rep1_n

        d52_rep1_singlet <- subset(d52_rep1, vireo_best_assignment != "doublet" )
        d52_rep1_singlet <- nrow(d52_rep1_singlet)
        d52_rep1_unassigned <- subset(d52_rep1, vireo_eval == "yes")
        d52_rep1_unassigned <- nrow(d52_rep1_unassigned)
        d_52_vireo_r1_singlet <- 1- ((d52_rep1_unassigned)/d52_rep1_singlet)

        # R2
        d52_rep2_n <- nrow(d52_rep2)
        d52_rep2$vireo_eval <- "no"
        d52_rep2$vireo_eval[d52_rep2$vireo_assignment == "unassigned" & d52_rep2$vireo_best_assignment != "doublet"] <- "yes"
        d_52_vireo <- subset(d52_rep2, vireo_eval == "no")
        d_52_vireo <- nrow(d_52_vireo)
        d_52_vireo_2 <- d_52_vireo
        d_52_vireo_r2 <- d_52_vireo/d52_rep2_n

        d52_rep2_singlet <- subset(d52_rep2, vireo_best_assignment != "doublet" )
        d52_rep2_singlet <- nrow(d52_rep2_singlet)
        d52_rep2_unassigned <- subset(d52_rep2, vireo_eval == "yes")
        d52_rep2_unassigned <- nrow(d52_rep2_unassigned)
        d_52_vireo_r2_singlet <- 1- ((d52_rep2_unassigned)/d52_rep2_singlet)

        # R3
        d52_rep3_n <- nrow(d52_rep3)
        d52_rep3$vireo_eval <- "no"
        d52_rep3$vireo_eval[d52_rep3$vireo_assignment == "unassigned" & d52_rep3$vireo_best_assignment != "doublet"] <- "yes"
        d_52_vireo <- subset(d52_rep3, vireo_eval == "no")
        d_52_vireo <- nrow(d_52_vireo)
        d_52_vireo_3 <- d_52_vireo
        d_52_vireo_r3 <- d_52_vireo/d52_rep3_n

        d52_rep3_singlet <- subset(d52_rep3, vireo_best_assignment != "doublet" )
        d52_rep3_singlet <- nrow(d52_rep3_singlet)
        d52_rep3_unassigned <- subset(d52_rep3, vireo_eval == "yes")
        d52_rep3_unassigned <- nrow(d52_rep3_unassigned)
        d_52_vireo_r3_singlet <- 1- ((d52_rep3_unassigned)/d52_rep3_singlet)

        d_11_temp <- c(d11_rep1_unassigned + d11_rep2_unassigned + d11_rep3_unassigned)
        d_30_temp <- c(d30_rep1_unassigned + d30_rep2_unassigned + d30_rep3_unassigned)
        d_52_temp <- c(d52_rep1_unassigned + d52_rep2_unassigned + d52_rep3_unassigned)
        d_30_prop_temp  <- d_30_temp/(d_11_temp+ d_30_temp+ d_52_temp)
        d_30_prop_temp

        ## bind
        #D11 
        total <- d11_rep1_n + d11_rep2_n + d11_rep3_n
        assigned <- d_11_vireo_1 + d_11_vireo_2 + d_11_vireo_3 
        d_11_prop <- assigned/total
        #D30 
        total <- d30_rep1_n + d30_rep2_n + d30_rep3_n
        assigned <- d_30_vireo_1 + d_30_vireo_2 + d_30_vireo_3 
        d_30_prop <- assigned/total
        #D52
        total <- d52_rep1_n + d52_rep2_n + d52_rep3_n 
        assigned <- d_52_vireo_1 + d_52_vireo_2 + d_52_vireo_3
        d_52_prop <- assigned/total

        bind <- data.frame(prop = c(d_11_prop,d_30_prop,d_52_prop  ), day = c("11", "30", "52"))
        bind$assigned <- bind$prop
        bind$unassigned <- 1 - bind$prop

        ## long format
        bind_df_long <- gather(bind, class, measurement, unassigned:assigned, factor_key=TRUE)
        bind_df_long$day <- factor(bind_df_long$day, levels = c("52", "30", "11"))

        ggplot(bind_df_long, aes(y = day, x = measurement, fill = class)) +geom_bar(stat = 'identity') + theme_classic() + 
            theme(axis.title = element_blank(), 
            legend.position = "none",
            axis.text.y = element_text(face = "bold", colour = "black", size = 12),
            axis.text.x = element_text(colour = "black", size = 12),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank()) +
            scale_fill_manual(values = c("red", "lightsteelblue1")) +
            scale_y_discrete(labels = c("D52", "D30", "D11")) +
            scale_x_continuous(expand= c(0,0), breaks = c(0, 0.5, 1), labels = c('0', '0.5', '1'))
        ggsave(paste(output_dir,"/prop_vireo.pdf", sep=""), width = 2.25, height = 1)
    ##
    ################################################
    ## Souporcell
    ################################################
    ## code
        ## D11 
        # R1
        d11_rep1_n <- nrow(d11_rep1)
        d11_rep1$souporcell_eval <- "no"
        d11_rep1$souporcell_eval[d11_rep1$souporcell_assignment == "unassigned" & d11_rep1$souporcell_best_assignment != "doublet"] <- "yes"
        d_11_souporcell <- subset(d11_rep1, souporcell_eval == "no")
        d_11_souporcell <- nrow(d_11_souporcell)
        d_11_souporcell_1 <- d_11_souporcell
        d_11_souporcell_r1 <- d_11_souporcell/d11_rep1_n

        d11_rep1_singlet <- subset(d11_rep1, souporcell_best_assignment != "doublet" )
        d11_rep1_singlet <- nrow(d11_rep1_singlet)
        d11_rep1_unassigned <- subset(d11_rep1, souporcell_eval == "yes")
        d11_rep1_unassigned <- nrow(d11_rep1_unassigned)
        d_11_souporcell_r1_singlet <- 1- ((d11_rep1_unassigned)/d11_rep1_singlet)

        # R2
        d11_rep2_n <- nrow(d11_rep2)
        d11_rep2$souporcell_eval <- "no"
        d11_rep2$souporcell_eval[d11_rep2$souporcell_assignment == "unassigned" & d11_rep2$souporcell_best_assignment != "doublet"] <- "yes"
        d_11_souporcell <- subset(d11_rep2, souporcell_eval == "no")
        d_11_souporcell <- nrow(d_11_souporcell)
        d_11_souporcell_2 <- d_11_souporcell
        d_11_souporcell_r2 <- d_11_souporcell/d11_rep2_n

        d11_rep2_singlet <- subset(d11_rep2, souporcell_best_assignment != "doublet" )
        d11_rep2_singlet <- nrow(d11_rep2_singlet)
        d11_rep2_unassigned <- subset(d11_rep2, souporcell_eval == "yes")
        d11_rep2_unassigned <- nrow(d11_rep2_unassigned)
        d_11_souporcell_r2_singlet <- 1- ((d11_rep2_unassigned)/d11_rep2_singlet)

        # R3
        d11_rep3_n <- nrow(d11_rep3)
        d11_rep3$souporcell_eval <- "no"
        d11_rep3$souporcell_eval[d11_rep3$souporcell_assignment == "unassigned" & d11_rep3$souporcell_best_assignment != "doublet"] <- "yes"
        d_11_souporcell <- subset(d11_rep3, souporcell_eval == "no")
        d_11_souporcell <- nrow(d_11_souporcell)
        d_11_souporcell_3 <- d_11_souporcell
        d_11_souporcell_r3 <- d_11_souporcell/d11_rep3_n

        d11_rep3_singlet <- subset(d11_rep3, souporcell_best_assignment != "doublet" )
        d11_rep3_singlet <- nrow(d11_rep3_singlet)
        d11_rep3_unassigned <- subset(d11_rep3, souporcell_eval == "yes")
        d11_rep3_unassigned <- nrow(d11_rep3_unassigned)
        d_11_souporcell_r3_singlet <- 1- ((d11_rep3_unassigned)/d11_rep3_singlet)

        ## D30
        # R1
        d30_rep1_n <- nrow(d30_rep1)
        d30_rep1$souporcell_eval <- "no"
        d30_rep1$souporcell_eval[d30_rep1$souporcell_assignment == "unassigned" & d30_rep1$souporcell_best_assignment != "doublet"] <- "yes"
        d_30_souporcell <- subset(d30_rep1, souporcell_eval == "no")
        d_30_souporcell <- nrow(d_30_souporcell)
        d_30_souporcell_1 <- d_30_souporcell
        d_30_souporcell_r1 <- d_30_souporcell/d30_rep1_n

        d30_rep1_singlet <- subset(d30_rep1, souporcell_best_assignment != "doublet" )
        d30_rep1_singlet <- nrow(d30_rep1_singlet)
        d30_rep1_unassigned <- subset(d30_rep1, souporcell_eval == "yes")
        d30_rep1_unassigned <- nrow(d30_rep1_unassigned)
        d_30_souporcell_r1_singlet <- 1- ((d30_rep1_unassigned)/d30_rep1_singlet)

        # R2
        d30_rep2_n <- nrow(d30_rep2)
        d30_rep2$souporcell_eval <- "no"
        d30_rep2$souporcell_eval[d30_rep2$souporcell_assignment == "unassigned" & d30_rep2$souporcell_best_assignment != "doublet"] <- "yes"
        d_30_souporcell <- subset(d30_rep2, souporcell_eval == "no")
        d_30_souporcell <- nrow(d_30_souporcell)
        d_30_souporcell_2 <- d_30_souporcell
        d_30_souporcell_r2 <- d_30_souporcell/d30_rep2_n

        d30_rep2_singlet <- subset(d30_rep2, souporcell_best_assignment != "doublet" )
        d30_rep2_singlet <- nrow(d30_rep2_singlet)
        d30_rep2_unassigned <- subset(d30_rep2, souporcell_eval == "yes")
        d30_rep2_unassigned <- nrow(d30_rep2_unassigned)
        d_30_souporcell_r2_singlet <- 1- ((d30_rep2_unassigned)/d30_rep2_singlet)

        # R3
        d30_rep3_n <- nrow(d30_rep3)
        d30_rep3$souporcell_eval <- "no"
        d30_rep3$souporcell_eval[d30_rep3$souporcell_assignment == "unassigned"& d30_rep3$souporcell_best_assignment != "doublet"] <- "yes"
        d_30_souporcell <- subset(d30_rep3, souporcell_eval == "no")
        d_30_souporcell <- nrow(d_30_souporcell)
        d_30_souporcell_3 <- d_30_souporcell
        d_30_souporcell_r3 <- d_30_souporcell/d30_rep3_n

        d30_rep3_singlet <- subset(d30_rep3, souporcell_best_assignment != "doublet" )
        d30_rep3_singlet <- nrow(d30_rep3_singlet)
        d30_rep3_unassigned <- subset(d30_rep3, souporcell_eval == "yes")
        d30_rep3_unassigned <- nrow(d30_rep3_unassigned)
        d_30_souporcell_r3_singlet <- 1- ((d30_rep3_unassigned)/d30_rep3_singlet)

        ## D52
        # R1
        d52_rep1_n <- nrow(d52_rep1)
        d52_rep1$souporcell_eval <- "no"
        d52_rep1$souporcell_eval[d52_rep1$souporcell_assignment == "unassigned" & d52_rep1$souporcell_best_assignment != "doublet"] <- "yes"
        d_52_souporcell <- subset(d52_rep1, souporcell_eval == "no")
        d_52_souporcell <- nrow(d_52_souporcell)
        d_52_souporcell_1 <- d_52_souporcell
        d_52_souporcell_r1 <- d_52_souporcell/d52_rep1_n

        d52_rep1_singlet <- subset(d52_rep1, souporcell_best_assignment != "doublet" )
        d52_rep1_singlet <- nrow(d52_rep1_singlet)
        d52_rep1_unassigned <- subset(d52_rep1, souporcell_eval == "yes")
        d52_rep1_unassigned <- nrow(d52_rep1_unassigned)
        d_52_souporcell_r1_singlet <- 1- ((d52_rep1_unassigned)/d52_rep1_singlet)

        # R2
        d52_rep2_n <- nrow(d52_rep2)
        d52_rep2$souporcell_eval <- "no"
        d52_rep2$souporcell_eval[d52_rep2$souporcell_assignment == "unassigned" & d52_rep2$souporcell_best_assignment != "doublet"] <- "yes"
        d_52_souporcell <- subset(d52_rep2, souporcell_eval == "no")
        d_52_souporcell <- nrow(d_52_souporcell)
        d_52_souporcell_2 <- d_52_souporcell
        d_52_souporcell_r2 <- d_52_souporcell/d52_rep2_n

        d52_rep2_singlet <- subset(d52_rep2, souporcell_best_assignment != "doublet" )
        d52_rep2_singlet <- nrow(d52_rep2_singlet)
        d52_rep2_unassigned <- subset(d52_rep2, souporcell_eval == "yes")
        d52_rep2_unassigned <- nrow(d52_rep2_unassigned)
        d_52_souporcell_r2_singlet <- 1- ((d52_rep2_unassigned)/d52_rep2_singlet)

        # R3
        d52_rep3_n <- nrow(d52_rep3)
        d52_rep3$souporcell_eval <- "no"
        d52_rep3$souporcell_eval[d52_rep3$souporcell_assignment == "unassigned" & d52_rep3$souporcell_best_assignment != "doublet"] <- "yes"
        d_52_souporcell <- subset(d52_rep3, souporcell_eval == "no")
        d_52_souporcell <- nrow(d_52_souporcell)
        d_52_souporcell_3 <- d_52_souporcell
        d_52_souporcell_r3 <- d_52_souporcell/d52_rep3_n

        d52_rep3_singlet <- subset(d52_rep3, souporcell_best_assignment != "doublet" )
        d52_rep3_singlet <- nrow(d52_rep3_singlet)
        d52_rep3_unassigned <- subset(d52_rep3, souporcell_eval == "yes")
        d52_rep3_unassigned <- nrow(d52_rep3_unassigned)
        d_52_souporcell_r3_singlet <- 1- ((d52_rep3_unassigned)/d52_rep3_singlet)

        ## bind
        #D11 
        total <- d11_rep1_n + d11_rep2_n + d11_rep3_n
        assigned <- d_11_souporcell_1 + d_11_souporcell_2 + d_11_souporcell_3 
        d_11_prop <- assigned/total
        #D30 
        total <- d30_rep1_n + d30_rep2_n + d30_rep3_n
        assigned <- d_30_souporcell_1 + d_30_souporcell_2 + d_30_souporcell_3 
        d_30_prop <- assigned/total
        #D52
        total <- d52_rep1_n + d52_rep2_n + d52_rep3_n 
        assigned <- d_52_souporcell_1 + d_52_souporcell_2 + d_52_souporcell_3
        d_52_prop <- assigned/total

        bind <- data.frame(prop = c(d_11_prop,d_30_prop,d_52_prop  ), day = c("11", "30", "52"))
        bind$assigned <- bind$prop
        bind$unassigned <- 1 - bind$prop

        ## long format
        bind_df_long <- gather(bind, class, measurement, unassigned:assigned, factor_key=TRUE)
        bind_df_long$day <- factor(bind_df_long$day, levels = c("52", "30", "11"))

        ggplot(bind_df_long, aes(y = day, x = measurement, fill = class)) +geom_bar(stat = 'identity') + theme_classic() + 
            theme(axis.title = element_blank(), 
            legend.position = "none",
            axis.text.y = element_text(face = "bold", colour = "black", size = 12),
            axis.text.x = element_text(colour = "black", size = 12),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank()) +
            scale_fill_manual(values = c("red", "lightsteelblue1")) +
            scale_y_discrete(labels = c("D52", "D30", "D11")) +
            scale_x_continuous(expand= c(0,0), breaks = c(0, 0.5, 1), labels = c('0', '0.5', '1'))
        ggsave(paste(output_dir,"/prop_souporcell.pdf", sep=""), width = 2.25, height = 1)
    ##

    ## Dataframe and Plot
        df_prop <- data.frame(tool = c("Ensemblux","Ensemblux","Ensemblux","Ensemblux","Ensemblux","Ensemblux","Ensemblux","Ensemblux","Ensemblux",
                                        "Demuxlet","Demuxlet","Demuxlet","Demuxlet","Demuxlet","Demuxlet","Demuxlet","Demuxlet","Demuxlet",
                                        "Demuxalot","Demuxalot","Demuxalot","Demuxalot","Demuxalot","Demuxalot","Demuxalot","Demuxalot","Demuxalot",
                                        "Vireo","Vireo","Vireo","Vireo","Vireo","Vireo","Vireo","Vireo","Vireo",
                                        "Souporcell","Souporcell","Souporcell","Souporcell","Souporcell","Souporcell","Souporcell","Souporcell", "Souporcell"),
        prop = c(d_11_ensemblux_r1_singlet, d_11_ensemblux_r2_singlet, d_11_ensemblux_r3_singlet, 
                    d_30_ensemblux_r1_singlet, d_30_ensemblux_r2_singlet, d_30_ensemblux_r3_singlet, 
                    d_52_ensemblux_r1_singlet, d_52_ensemblux_r2_singlet, d_52_ensemblux_r3_singlet,
                    d_11_demuxlet_r1_singlet, d_11_demuxlet_r2_singlet, d_11_demuxlet_r3_singlet,
                    d_30_demuxlet_r1_singlet, d_30_demuxlet_r2_singlet, d_30_demuxlet_r3_singlet,  
                    d_52_demuxlet_r1_singlet, d_52_demuxlet_r2_singlet, d_52_demuxlet_r3_singlet,     
                    d_11_demuxalot_r1_singlet, d_11_demuxalot_r2_singlet, d_11_demuxalot_r3_singlet,
                    d_30_demuxalot_r1_singlet, d_30_demuxalot_r2_singlet, d_30_demuxalot_r3_singlet,  
                    d_52_demuxalot_r1_singlet, d_52_demuxalot_r2_singlet, d_52_demuxalot_r3_singlet,
                    d_11_vireo_r1_singlet, d_11_vireo_r2_singlet, d_11_vireo_r3_singlet,
                    d_30_vireo_r1_singlet, d_30_vireo_r2_singlet, d_30_vireo_r3_singlet,  
                    d_52_vireo_r1_singlet, d_52_vireo_r2_singlet, d_52_vireo_r3_singlet,     
                    d_11_souporcell_r1_singlet, d_11_souporcell_r2_singlet, d_11_souporcell_r3_singlet,
                    d_30_souporcell_r1_singlet, d_30_souporcell_r2_singlet, d_30_souporcell_r3_singlet,  
                    d_52_souporcell_r1_singlet, d_52_souporcell_r2_singlet, d_52_souporcell_r3_singlet
                    ))
        df_prop$tool <- factor(df_prop$tool, levels = c("Ensemblux","Demuxalot", "Demuxlet", "Souporcell", "Vireo"))

        ## Compute mean and quantile for boxplot
            df1 <- df_prop %>% 
            group_by(tool) %>% 
            summarize(d_ymin = min(prop),
                    d_ymax = max(prop),
                    d_lower = quantile(prop, 0.25),
                    d_middle = mean(prop),
                    d_upper = quantile(prop, 0.75)) %>% as.data.frame()

            df1$tool <- factor(df1$tool, levels = c("Ensemblux", "Demuxalot", "Demuxlet", "Souporcell", "Vireo"))

        ## plot
        ggplot(df1) + 
        geom_boxplot(aes(x = tool,
                        ymin = d_ymin,
                        lower = d_lower,
                        middle = d_middle,
                        upper = d_upper,
                        ymax = d_ymax,
                        colour = tool), stat = "identity") + theme_classic() +
            theme(axis.title.y = element_text(size = 12, face = "bold"),
            axis.title.x = element_blank(), 
            axis.text.y = element_text(size = 12, colour = "black"),
            axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1),
            legend.position = "none") + 
            scale_colour_manual(values = c("black","#d95f02", "#e6ab02", "#7570b3", "#66a61e")) +
            ylab("Proportion of confidently\nclassified singlets") #+
            ggsave(paste(output_dir,"/prop_conf_singlet.pdf", sep=""), width = 2.25, height = 3.25) 

        ## Wilcoxon rank-sum test
        wilcox.test(df_prop$prop[df_prop$tool == "Ensemblux"], df_prop$prop[df_prop$tool == "Demuxlet"], alternative = "greater")
        wilcox.test(df_prop$prop[df_prop$tool == "Ensemblux"], df_prop$prop[df_prop$tool == "Demuxalot"], alternative = "greater")
        wilcox.test(df_prop$prop[df_prop$tool == "Ensemblux"], df_prop$prop[df_prop$tool == "Souporcell"], alternative = "greater")
        wilcox.test(df_prop$prop[df_prop$tool == "Ensemblux"], df_prop$prop[df_prop$tool == "Vireo"], alternative = "greater")
    ##
##

###################################################################
# Compute proportion of ambiguous singlets across remaining tools #
###################################################################
## code
    ## Load Seurat object
    seu_int<-readRDS("~/ensemblux_manuscript/Figure5/pool5_seurat_integrated_all_timepoints.rds.rds")
    output_dir <- "~/ensemblux_manuscript/Figure5"
    df <- data.frame(seu_int@meta.data)

    ### Add Ensemblux and Demuxlet eval columns
    ## Ensemblux
    df$ensemblux_eval <- "no"
    df$ensemblux_eval[df$Ensemblux_assignment == "unassigned"] <- "yes"
    ## Demuxlet
    df$demuxlet_eval <- "no"
    df$demuxlet_eval[df$demuxlet_assignment == "unassigned" & df$demuxlet_best_assignment != "doublet" ] <- "yes"
    ## Demuxalot
    df$demuxalotx_eval <- "no"
    df$demuxalotx_eval[df$demuxalot_assignment == "unassigned" & df$demuxalot_best_assignment != "doublet"] <- "yes"
    ## Vireo
    df$vireo_eval <- "no"
    df$vireo_eval[df$vireo_assignment == "unassigned" & df$vireo_best_assignment != "doublet"] <- "yes"
    ## Souporcell
    df$souporcell_eval <- "no"
    df$souporcell_eval[df$souporcell_assignment == "unassigned" & df$souporcell_best_assignment != "doublet"] <- "yes"

    df <- df %>% dplyr::select(ensemblux_eval, demuxlet_eval, demuxalotx_eval, vireo_eval, souporcell_eval)

    ## Add the metadata
    seu_int <- AddMetaData(seu_int, df)
    df <- data.frame(seu_int@meta.data)

    #############
    # Ensemblux #
    #############
        df_unassigned.ensemblux <- subset(df, ensemblux_eval == "yes" )
        length <- nrow(df_unassigned.ensemblux)
        ## Demuxalot
        length_2 <- subset(df_unassigned.ensemblux, demuxalot_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Ensemblux"
        tool <- "Demuxalot"
        df_unassigned.ensemblux.demuxalot <- data.frame(prop,class, tool)
        ## Vireo
        length_2 <- subset(df_unassigned.ensemblux, vireo_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Ensemblux"
        tool <- "Vireo"
        df_unassigned.ensemblux.vireo <- data.frame(prop,class, tool)
        ## Souporcell
        length_2 <- subset(df_unassigned.ensemblux, souporcell_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Ensemblux"
        tool <- "Souporcell"
        df_unassigned.ensemblux.souporcell <- data.frame(prop,class, tool)
        ## Demuxlet
        length_2 <- subset(df_unassigned.ensemblux, demuxlet_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Ensemblux"
        tool <- "Demuxlet"
        df_unassigned.ensemblux.demuxlet <- data.frame(prop,class, tool)
    #############
    # Demuxalot #
    #############
        df_unassigned.demuxalot <- subset(df, demuxalotx_eval == "yes" )
        length <- nrow(df_unassigned.demuxalot)
        ## Ensemblux
        length_2 <- subset(df_unassigned.demuxalot, Ensemblux_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Demuxalot"
        tool <- "Ensemblux"
        df_unassigned.demuxalot.ensemblux <- data.frame(prop,class, tool)
        ## Vireo
        length_2 <- subset(df_unassigned.demuxalot, vireo_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Demuxalot"
        tool <- "Vireo"
        df_unassigned.demuxalot.vireo <- data.frame(prop,class, tool)
        ## Souporcell
        length_2 <- subset(df_unassigned.demuxalot, souporcell_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Demuxalot"
        tool <- "Souporcell"
        df_unassigned.demuxalot.souporcell <- data.frame(prop,class, tool)
        ## Demuxlet
        length_2 <- subset(df_unassigned.demuxalot, demuxlet_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Demuxalot"
        tool <- "Demuxlet"
        df_unassigned.demuxalot.demuxlet <- data.frame(prop,class, tool)
    ############
    # Demuxlet #
    ############
        df_unassigned.demuxlet <- subset(df, demuxlet_eval == "yes" )
        length <- nrow(df_unassigned.demuxlet)
        ## Ensemblux
        length_2 <- subset(df_unassigned.demuxlet, Ensemblux_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Demuxlet"
        tool <- "Ensemblux"
        df_unassigned.demuxlet.ensemblux <- data.frame(prop,class, tool)
        ## Vireo
        length_2 <- subset(df_unassigned.demuxlet, vireo_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Demuxlet"
        tool <- "Vireo"
        df_unassigned.demuxlet.vireo <- data.frame(prop,class, tool)
        ## Souporcell
        length_2 <- subset(df_unassigned.demuxlet, souporcell_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Demuxlet"
        tool <- "Souporcell"
        df_unassigned.demuxlet.souporcell <- data.frame(prop,class, tool)
        ## Demuxalot
        length_2 <- subset(df_unassigned.demuxlet, demuxalot_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Demuxlet"
        tool <- "Demuxalot"
        df_unassigned.demuxlet.demuxalot <- data.frame(prop,class, tool)
    #########
    # Vireo #
    #########
        df_unassigned.vireo <- subset(df, vireo_eval == "yes" )
        length <- nrow(df_unassigned.vireo)
        ## Ensemblux
        length_2 <- subset(df_unassigned.vireo, Ensemblux_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Vireo"
        tool <- "Ensemblux"
        df_unassigned.vireo.ensemblux <- data.frame(prop,class, tool)
        ## Demuxlet
        length_2 <- subset(df_unassigned.vireo, demuxlet_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Vireo"
        tool <- "Demuxlet"
        df_unassigned.vireo.demuxlet <- data.frame(prop,class, tool)
        ## Souporcell
        length_2 <- subset(df_unassigned.vireo, souporcell_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Vireo"
        tool <- "Souporcell"
        df_unassigned.vireo.souporcell <- data.frame(prop,class, tool)
        ## Demuxalot
        length_2 <- subset(df_unassigned.vireo, demuxalot_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Vireo"
        tool <- "Demuxalot"
        df_unassigned.vireo.demuxalot <- data.frame(prop,class, tool)
    ##############
    # Souporcell #
    ##############
        df_unassigned.souporcell <- subset(df, souporcell_eval == "yes" )
        length <- nrow(df_unassigned.souporcell)
        ## Ensemblux
        length_2 <- subset(df_unassigned.souporcell, Ensemblux_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Souporcell"
        tool <- "Ensemblux"
        df_unassigned.souporcell.ensemblux <- data.frame(prop,class, tool)
        ## Demuxlet
        length_2 <- subset(df_unassigned.souporcell, demuxlet_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Souporcell"
        tool <- "Demuxlet"
        df_unassigned.souporcell.demuxlet <- data.frame(prop,class, tool)
        ## Vireo
        length_2 <- subset(df_unassigned.souporcell, vireo_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Souporcell"
        tool <- "Vireo"
        df_unassigned.souporcell.vireo <- data.frame(prop,class, tool)
        ## Demuxalot
        length_2 <- subset(df_unassigned.souporcell, demuxalot_assignment == "unassigned") %>% nrow()
        prop <- length_2/length
        class <- "Souporcell"
        tool <- "Demuxalot"
        df_unassigned.souporcell.demuxalot <- data.frame(prop,class, tool)
    ## Dataframe and plot
    bind_all <- rbind(df_unassigned.ensemblux.demuxalot, df_unassigned.ensemblux.vireo,df_unassigned.ensemblux.souporcell, df_unassigned.ensemblux.demuxlet, 
                    df_unassigned.demuxlet.demuxalot, df_unassigned.demuxlet.vireo,df_unassigned.demuxlet.souporcell, df_unassigned.demuxlet.ensemblux, 
                    df_unassigned.demuxalot.ensemblux, df_unassigned.demuxalot.vireo,df_unassigned.demuxalot.souporcell, df_unassigned.demuxalot.demuxlet,
                    df_unassigned.vireo.demuxalot, df_unassigned.vireo.ensemblux,df_unassigned.vireo.souporcell, df_unassigned.vireo.demuxlet,
                    df_unassigned.souporcell.demuxalot, df_unassigned.souporcell.vireo,df_unassigned.souporcell.ensemblux, df_unassigned.souporcell.demuxlet )

    bind_all$class <- factor(bind_all$class, levels = c('Ensemblux', 'Demuxalot', 'Demuxlet', 'Souporcell', 'Vireo'))
    bind_all$tool <- factor(bind_all$tool, levels = c('Ensemblux', 'Demuxalot', 'Demuxlet', 'Souporcell', 'Vireo'))

    ggplot(bind_all, aes(y = prop, x = tool, fill = tool)) +
        geom_bar(stat = "identity") +
        theme_bw() + 
        theme(axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust =1),
            axis.text.y = element_text(size = 12, colour = "black"),
            axis.title.x = element_blank(), 
            axis.title.y = element_text(size = 12, face = "bold"),
            legend.position = "none",
            panel.grid = element_blank()) + 
        scale_fill_manual(values = c("black","#d95f02", "#e6ab02", "#7570b3", "#66a61e")) +
        scale_y_continuous(limits = c(0,1)) + 
        ylab("Proportion of\nunassigned cells") + 
        facet_wrap(~class, scales = "free", ncol = 5)
    ggsave(paste(output_dir,"/overlap_amb.pdf", sep=""), width = 8, height = 2.75)
##

###########################################################
# Clustering-resolution specific Adjusted Rand Index plot #
###########################################################
## code
    ##########
    # Day 11 #
    ##########
    ## Ensemblux d11
        ensemblux <- read.xlsx('~/ensemblux_manuscript/Figure5/Ensemblux_d11_all/clustering_ARI.xlsx')
        ensemblux <- data.frame(ensemblux)
        mean <- list(ensemblux[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(ensemblux[,21:ncol(ensemblux)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(ensemblux[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        ensemblux <- data.frame(mean, sd, res)
        ensemblux <- na.omit(ensemblux)
        ensemblux$class <- "Ensemblux"

    ## Demuxlet d11
        demuxlet <- read.xlsx('~/ensemblux_manuscript/Figure5/Demuxlet_d11_all/clustering_ARI.xlsx')
        demuxlet <- data.frame(demuxlet)
        mean <- list(demuxlet[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(demuxlet[,21:ncol(demuxlet)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(demuxlet[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        demuxlet <- data.frame(mean, sd, res)
        demuxlet <- na.omit(demuxlet)
        demuxlet$class <- "Demuxlet"

    ## None d11
        none <- read.xlsx('~/ensemblux_manuscript/Figure5/None_d11_all/clustering_ARI.xlsx')
        none <- data.frame(none)
        mean <- list(none[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(none[,21:ncol(none)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(none[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        none <- data.frame(mean, sd, res)
        none <- na.omit(none)
        none$class <- "None"

    ## DF d11
        doubletfinder <- read.xlsx('~/ensemblux_manuscript/Figure5/DoubletFinder_d11_all/clustering_ARI.xlsx')
        doubletfinder <- data.frame(doubletfinder)
        mean <- list(doubletfinder[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(doubletfinder[,21:ncol(doubletfinder)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(doubletfinder[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        doubletfinder <- data.frame(mean, sd, res)
        doubletfinder <- na.omit(doubletfinder)
        doubletfinder$class <- "DF"

    ## Demuxalot d11
        demuxalot <- read.xlsx('~/ensemblux_manuscript/Figure5/Demuxalot_d11_all/clustering_ARI.xlsx')
        demuxalot <- data.frame(demuxalot)
        mean <- list(demuxalot[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(demuxalot[,21:ncol(demuxalot)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(demuxalot[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        demuxalot <- data.frame(mean, sd, res)
        demuxalot <- na.omit(demuxalot)
        demuxalot$class <- "Demuxalot"

    ## Vireo d11
        vireo <- read.xlsx('~/ensemblux_manuscript/Figure5/Vireo_d11_all/clustering_ARI.xlsx')
        vireo <- data.frame(vireo)
        mean <- list(vireo[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(vireo[,21:ncol(vireo)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(vireo[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        vireo <- data.frame(mean, sd, res)
        vireo <- na.omit(vireo)
        vireo$class <- "Vireo"

    ## Souporcell d11
        souporcell <- read.xlsx('~/ensemblux_manuscript/Figure5/Souporcell_d11_all/clustering_ARI.xlsx')
        souporcell <- data.frame(souporcell)
        mean <- list(souporcell[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(souporcell[,21:ncol(souporcell)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(souporcell[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        souporcell <- data.frame(mean, sd, res)
        souporcell <- na.omit(souporcell)
        souporcell$class <- "Souporcell"

    ## Dataframe 
            bind <- rbind(ensemblux, demuxlet, none, doubletfinder, demuxalot, vireo, souporcell)
            bind$class <- factor(bind$class, levels = c("Ensemblux", "Demuxalot", "Demuxlet", "Souporcell", "Vireo", "DF", "None"))
            bind_11 <- bind
    ##
        
    ##########
    # Day 30 #
    ##########
    ## Ensemblux d30
        ensemblux <- openxlsx::read.xlsx('~/ensemblux_manuscript/Figure5/Ensemblux_d30_all/clustering_ARI.xlsx')
        ensemblux <- data.frame(ensemblux)
        mean <- list(ensemblux[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(ensemblux[,21:ncol(ensemblux)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(ensemblux[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        ensemblux <- data.frame(mean, sd, res)
        ensemblux <- na.omit(ensemblux)
        ensemblux$class <- "Ensemblux"

    ## Demuxlet d30
        demuxlet <- openxlsx::read.xlsx('~/ensemblux_manuscript/Figure5/Demuxlet_d30_all/clustering_ARI.xlsx')
        demuxlet <- data.frame(demuxlet)
        mean <- list(demuxlet[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(demuxlet[,21:ncol(demuxlet)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(demuxlet[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        demuxlet <- data.frame(mean, sd, res)
        demuxlet <- na.omit(demuxlet)
        demuxlet$class <- "Demuxlet"

    ## None d30
        none <- openxlsx::read.xlsx('~/ensemblux_manuscript/Figure5/None_d30_all/clustering_ARI.xlsx')
        none <- data.frame(none)
        mean <- list(none[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(none[,21:ncol(none)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(none[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        none <- data.frame(mean, sd, res)
        none <- na.omit(none)
        none$class <- "None"

    ## DF d30
        doubletfinder <- read.xlsx('~/ensemblux_manuscript/Figure5/DoubletFinder_d30_all/clustering_ARI.xlsx')
        doubletfinder <- data.frame(doubletfinder)
        mean <- list(doubletfinder[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(doubletfinder[,21:ncol(doubletfinder)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(doubletfinder[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        doubletfinder <- data.frame(mean, sd, res)
        doubletfinder <- na.omit(doubletfinder)
        doubletfinder$class <- "DF"

    ## Demuxalot d30
        demuxalot <- read.xlsx('~/ensemblux_manuscript/Figure5/Demuxalot_d30_all/clustering_ARI.xlsx')
        demuxalot <- data.frame(demuxalot)
        mean <- list(demuxalot[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(demuxalot[,21:ncol(demuxalot)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(demuxalot[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        demuxalot <- data.frame(mean, sd, res)
        demuxalot <- na.omit(demuxalot)
        demuxalot$class <- "Demuxalot"

    ## Vireo d30
        vireo <- read.xlsx('~/ensemblux_manuscript/Figure5/Vireo_d30_all/clustering_ARI.xlsx')
        vireo <- data.frame(vireo)
        mean <- list(vireo[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(vireo[,21:ncol(vireo)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(vireo[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        vireo <- data.frame(mean, sd, res)
        vireo <- na.omit(vireo)
        vireo$class <- "Vireo"   

    ## Souporcell d30
        souporcell <- read.xlsx('~/ensemblux_manuscript/Figure5/Souporcell_d30_all/clustering_ARI.xlsx')
        souporcell <- data.frame(souporcell)
        mean <- list(souporcell[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(souporcell[,21:ncol(souporcell)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(souporcell[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        souporcell <- data.frame(mean, sd, res)
        souporcell <- na.omit(souporcell)
        souporcell$class <- "Souporcell"  

    ## Dataframe
            bind <- rbind(ensemblux, demuxlet, none, doubletfinder, demuxalot, vireo, souporcell)
            bind$class <- factor(bind$class, levels = c("Ensemblux", "Demuxalot", "Demuxlet", "Souporcell", "Vireo", "DF", "None"))
            bind_30 <- bind
    ##

    ##########
    # Day 52 #
    ##########
    ## Ensemblux d52
        ensemblux <- openxlsx::read.xlsx('~/ensemblux_manuscript/Figure5/Ensemblux_d52_all/clustering_ARI_2.xlsx')
        ensemblux <- data.frame(ensemblux)
        mean <- list(ensemblux[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(ensemblux[,21:ncol(ensemblux)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(ensemblux[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        ensemblux <- data.frame(mean, sd, res)
        ensemblux <- na.omit(ensemblux)
        ensemblux$class <- "Ensemblux"

    ## Demuxlet d52
        demuxlet <- openxlsx::read.xlsx('~/ensemblux_manuscript/Figure5/Demuxlet_d52_all/clustering_ARI_2.xlsx')
        demuxlet <- data.frame(demuxlet)
        #demuxlet <- demuxlet[,-1]
        mean <- list(demuxlet[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(demuxlet[,21:ncol(demuxlet)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(demuxlet[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        #res <- as.numeric(res)
        demuxlet <- data.frame(mean, sd, res)
        demuxlet <- na.omit(demuxlet)
        demuxlet$class <- "Demuxlet"

    ## None d52
        none <- openxlsx::read.xlsx('~/ensemblux_manuscript/Figure5/None_d52_all/clustering_ARI_2.xlsx')
        none <- data.frame(none)
        #none <- none[,-1]
        mean <- list(none[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(none[,21:ncol(none)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(none[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        #res <- as.numeric(res)
        none <- data.frame(mean, sd, res)
        none <- na.omit(none)
        none$class <- "None"

    ## DF d52
        doubletfinder <- read.xlsx('~/ensemblux_manuscript/Figure5/DoubletFinder_d52_all/clustering_ARI_2.xlsx')
        doubletfinder <- data.frame(doubletfinder)
        mean <- list(doubletfinder[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(doubletfinder[,21:ncol(doubletfinder)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(doubletfinder[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        #res <- as.numeric(res)
        doubletfinder <- data.frame(mean, sd, res)
        doubletfinder <- na.omit(doubletfinder)
        doubletfinder$class <- "DF"

    ## Demuxalot d52
        demuxalot <- read.xlsx('~/ensemblux_manuscript/Figure5/Demuxalot_d52_all/clustering_ARI_2.xlsx')
        demuxalot <- data.frame(demuxalot)
        mean <- list(demuxalot[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(demuxalot[,21:ncol(demuxalot)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(demuxalot[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        #res <- as.numeric(res)
        demuxalot <- data.frame(mean, sd, res)
        demuxalot <- na.omit(demuxalot)
        demuxalot$class <- "Demuxalot"

    ## Vireo d52
        vireo <- read.xlsx('~/ensemblux_manuscript/Figure5/Vireo_d52_all/clustering_ARI_2.xlsx')
        vireo <- data.frame(vireo)
        mean <- list(vireo[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(vireo[,21:ncol(vireo)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(vireo[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        #res <- as.numeric(res)
        vireo <- data.frame(mean, sd, res)
        vireo <- na.omit(vireo)
        vireo$class <- "Vireo"

    ## Souporcell d52
        souporcell <- read.xlsx('~/ensemblux_manuscript/Figure5/Souporcell_d52_all/clustering_ARI_2.xlsx')
        souporcell <- data.frame(souporcell)
        mean <- list(souporcell[,1:20])
        mean <- unlist(mean)
        mean <- unname(mean)
        sd <- list(souporcell[,21:ncol(souporcell)])
        sd <- unlist(sd)
        sd <- unname(sd)
        res <- colnames(souporcell[,1:20])
        res <- c(res)
        res <- gsub(".*_","",res)
        #res <- as.numeric(res)
        souporcell <- data.frame(mean, sd, res)
        souporcell <- na.omit(souporcell)
        souporcell$class <- "Souporcell"

    ## Dataframe
            bind <- rbind(ensemblux, demuxlet, none, doubletfinder, demuxalot, vireo, souporcell)
            bind$class <- factor(bind$class, levels = c("Ensemblux", "Demuxalot", "Demuxlet", "Souporcell", "Vireo", "DF", "None"))
            bind_52 <- bind
    ##

    ########
    # Plot #
    ########
    ## code
        ## bind all
        bind_all <- rbind(bind_11, bind_30, bind_52)

        ## Compute mean and quantile for boxplot
        df1 <- bind_all %>% 
        group_by(class) %>% 
        summarize(d_ymin = min(mean),
                d_ymax = max(mean),
                d_lower = quantile(mean, 0.25),
                d_middle = mean(mean),
                d_upper = quantile(mean, 0.75)) %>% as.data.frame()

        df1$class <- factor(df1$class, levels = c("Ensemblux", "Demuxalot", "Demuxlet", "Souporcell", "Vireo", "DF", "None"))

        ## Plot
        ggplot(df1) + 
        geom_boxplot(aes(x = class,
                        ymin = d_ymin,
                        lower = d_lower,
                        middle = d_middle,
                        upper = d_upper,
                        ymax = d_ymax,
                        colour = class), stat = "identity") + theme_classic() +
            theme(axis.title.y = element_text(size = 12, face = "bold"),
            axis.title.x = element_blank(), 
            axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust =1),
            axis.text.y = element_text(size = 12, colour = "black"),
            legend.position = "none") + 
            scale_colour_manual(values = c("black","#d95f02", "#e6ab02", "#7570b3", "#66a61e", "dodgerblue2", "grey63")) +
            ylab("Adjusted Rand Index") + xlab(("Clustering resolution")) +
            scale_x_discrete(labels = c("Ensemblux", "Demuxalot",  "Demuxlet", "Souporcell", "Vireo", "DoubletFinder", "All cells"))
            ggsave(paste(output_dir,"/ARI_all_timepoints_mean.pdf", sep=""), width = 8, height = 2.75)

        ## Wilcoxon rank-sum test
        wilcox.test(bind_all$mean[bind_all$class == "Ensemblux"], bind_all$mean[bind_all$class == "Demuxalot"], alternative = "greater")
        wilcox.test(bind_all$mean[bind_all$class == "Ensemblux"], bind_all$mean[bind_all$class == "Demuxlet"], alternative = "greater")
        wilcox.test(bind_all$mean[bind_all$class == "Ensemblux"], bind_all$mean[bind_all$class == "Vireo"], alternative = "greater")
        wilcox.test(bind_all$mean[bind_all$class == "Ensemblux"], bind_all$mean[bind_all$class == "Souporcell"], alternative = "greater")
        wilcox.test(bind_all$mean[bind_all$class == "Ensemblux"], bind_all$mean[bind_all$class == "DF"], alternative = "greater")
        wilcox.test(bind_all$mean[bind_all$class == "Ensemblux"], bind_all$mean[bind_all$class == "None"], alternative = "greater")
##
